<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>LDS GRAPH — ValidKernel Entity Map</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/d3/7.8.5/d3.min.js"></script>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Space+Mono:ital,wght@0,400;0,700;1,400&family=Bebas+Neue&display=swap');

  :root {
    --black: #050505;
    --white: #f0ede6;
    --green: #00ff88;
    --red: #ff2244;
    --amber: #ffaa00;
    --blue: #00aaff;
    --purple: #aa44ff;
    --dim: #0d0d0d;
    --border: #1a1a1a;
    --text-dim: #333;
    --text-mid: #666;
  }

  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    background: var(--black);
    color: var(--white);
    font-family: 'Space Mono', monospace;
    height: 100vh;
    overflow: hidden;
    display: grid;
    grid-template-rows: 48px 1fr;
  }

  header {
    border-bottom: 1px solid var(--border);
    padding: 0 24px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    background: var(--black);
    z-index: 100;
  }

  .logo {
    font-family: 'Bebas Neue', sans-serif;
    font-size: 22px;
    letter-spacing: 6px;
    color: var(--white);
  }
  .logo span { color: var(--green); }

  .hright {
    display: flex;
    align-items: center;
    gap: 20px;
    font-size: 9px;
    color: var(--text-mid);
    letter-spacing: 1px;
  }

  .hstat {
    display: flex;
    align-items: center;
    gap: 6px;
  }

  .dot { width: 6px; height: 6px; border-radius: 50%; }
  .dot-green { background: var(--green); }
  .dot-amber { background: var(--amber); }
  .dot-blue { background: var(--blue); }
  .dot-purple { background: var(--purple); }
  .dot-red { background: var(--red); }
  .dot-dim { background: var(--text-dim); }

  main {
    display: grid;
    grid-template-columns: 1fr 320px;
    overflow: hidden;
  }

  #canvas {
    position: relative;
    overflow: hidden;
    background: var(--black);
  }

  svg {
    width: 100%;
    height: 100%;
  }

  /* Grid lines */
  .grid-line { stroke: #0f0f0f; stroke-width: 1; }

  /* Edge styles */
  .edge {
    fill: none;
    stroke-width: 1.5;
    opacity: 0.6;
  }
  .edge-supersedes { stroke: var(--amber); stroke-dasharray: none; }
  .edge-relates_to { stroke: var(--blue); stroke-dasharray: 4,3; }
  .edge-requires { stroke: var(--red); stroke-dasharray: 2,4; opacity: 0.4; }
  .edge-implies { stroke: var(--purple); stroke-dasharray: 6,4; opacity: 0.3; }

  .edge-label {
    font-family: 'Space Mono', monospace;
    font-size: 8px;
    fill: var(--text-mid);
    letter-spacing: 1px;
  }

  /* Arrow markers */
  marker path { opacity: 0.7; }

  /* Node styles */
  .node { cursor: pointer; }

  .node-ring {
    fill: none;
    stroke-width: 1;
    opacity: 0.3;
  }

  .node-body {
    stroke-width: 1.5;
    transition: all 0.2s;
  }

  .node-label {
    font-family: 'Bebas Neue', sans-serif;
    font-size: 13px;
    fill: var(--white);
    letter-spacing: 2px;
    pointer-events: none;
    text-anchor: middle;
  }

  .node-sublabel {
    font-family: 'Space Mono', monospace;
    font-size: 7px;
    fill: var(--text-mid);
    pointer-events: none;
    text-anchor: middle;
    letter-spacing: 1px;
  }

  .node-id-label {
    font-family: 'Space Mono', monospace;
    font-size: 7px;
    pointer-events: none;
    text-anchor: middle;
    letter-spacing: 0.5px;
  }

  /* Ghost node (referenced but not in graph) */
  .node-ghost .node-body {
    fill: transparent;
    stroke-dasharray: 3,3;
    opacity: 0.4;
  }
  .node-ghost .node-label { fill: var(--text-mid); }

  /* Detail panel */
  .panel {
    border-left: 1px solid var(--border);
    display: flex;
    flex-direction: column;
    overflow: hidden;
    background: var(--dim);
  }

  .panel-head {
    padding: 16px 18px 12px;
    border-bottom: 1px solid var(--border);
    flex-shrink: 0;
  }

  .panel-title {
    font-family: 'Bebas Neue', sans-serif;
    font-size: 16px;
    letter-spacing: 3px;
    color: var(--green);
    margin-bottom: 2px;
  }

  .panel-sub {
    font-size: 8px;
    color: var(--text-mid);
    letter-spacing: 1px;
  }

  .panel-body {
    flex: 1;
    overflow-y: auto;
    padding: 16px 18px;
    display: flex;
    flex-direction: column;
    gap: 14px;
  }

  .panel-body::-webkit-scrollbar { width: 2px; }
  .panel-body::-webkit-scrollbar-track { background: transparent; }
  .panel-body::-webkit-scrollbar-thumb { background: var(--border); }

  .field-group { display: flex; flex-direction: column; gap: 6px; }

  .field-label {
    font-size: 7px;
    color: var(--text-mid);
    letter-spacing: 2px;
    text-transform: uppercase;
    border-bottom: 1px solid var(--border);
    padding-bottom: 4px;
  }

  .field-val {
    font-size: 10px;
    color: var(--white);
    line-height: 1.5;
    word-break: break-all;
  }

  .field-val.green { color: var(--green); }
  .field-val.amber { color: var(--amber); }
  .field-val.blue { color: var(--blue); }

  .tag {
    display: inline-block;
    background: rgba(0,255,136,0.08);
    border: 1px solid rgba(0,255,136,0.15);
    color: var(--green);
    font-size: 8px;
    padding: 2px 6px;
    margin: 2px 2px 2px 0;
    letter-spacing: 1px;
  }

  .tag-blue {
    background: rgba(0,170,255,0.08);
    border-color: rgba(0,170,255,0.15);
    color: var(--blue);
  }

  .tag-red {
    background: rgba(255,34,68,0.08);
    border-color: rgba(255,34,68,0.15);
    color: var(--red);
  }

  .tag-purple {
    background: rgba(170,68,255,0.08);
    border-color: rgba(170,68,255,0.15);
    color: var(--purple);
  }

  .tag-amber {
    background: rgba(255,170,0,0.08);
    border-color: rgba(255,170,0,0.15);
    color: var(--amber);
  }

  .bom-row {
    display: grid;
    grid-template-columns: 1fr auto;
    font-size: 9px;
    padding: 4px 0;
    border-bottom: 1px solid var(--border);
    gap: 8px;
  }
  .bom-row:last-child { border-bottom: none; }
  .bom-role { color: var(--white); }
  .bom-qty { color: var(--green); font-variant-numeric: tabular-nums; }
  .bom-mat { color: var(--text-mid); font-size: 8px; }

  .empty-panel {
    flex: 1;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    gap: 8px;
    color: var(--text-mid);
    font-size: 9px;
    text-align: center;
    padding: 20px;
  }

  .empty-big {
    font-family: 'Bebas Neue', sans-serif;
    font-size: 48px;
    color: var(--border);
    letter-spacing: 4px;
    line-height: 1;
  }

  /* Legend */
  .legend {
    padding: 12px 18px;
    border-top: 1px solid var(--border);
    display: flex;
    flex-direction: column;
    gap: 6px;
    flex-shrink: 0;
  }

  .legend-title {
    font-size: 7px;
    color: var(--text-mid);
    letter-spacing: 2px;
    text-transform: uppercase;
    margin-bottom: 2px;
  }

  .legend-row {
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 8px;
    color: var(--text-mid);
  }

  .legend-line {
    width: 24px;
    height: 1px;
    flex-shrink: 0;
  }

  /* Controls */
  .controls {
    position: absolute;
    bottom: 16px;
    left: 16px;
    display: flex;
    gap: 8px;
  }

  .ctrl-btn {
    background: var(--dim);
    border: 1px solid var(--border);
    color: var(--white);
    font-family: 'Space Mono', monospace;
    font-size: 12px;
    width: 28px;
    height: 28px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
  }
  .ctrl-btn:hover { border-color: var(--green); color: var(--green); }

  /* Node count badge */
  .badge {
    background: rgba(0,255,136,0.1);
    border: 1px solid rgba(0,255,136,0.2);
    color: var(--green);
    font-size: 8px;
    padding: 2px 8px;
    letter-spacing: 1px;
  }

  /* Pulse animation for active nodes */
  @keyframes pulse-ring {
    0% { r: 28; opacity: 0.3; }
    100% { r: 42; opacity: 0; }
  }

  .pulse-ring {
    fill: none;
    stroke: var(--green);
    stroke-width: 1;
    animation: pulse-ring 2s ease-out infinite;
  }

  /* Tooltip */
  .tooltip {
    position: absolute;
    background: var(--dim);
    border: 1px solid var(--border);
    padding: 6px 10px;
    font-size: 9px;
    color: var(--white);
    pointer-events: none;
    letter-spacing: 0.5px;
    max-width: 200px;
    line-height: 1.5;
    opacity: 0;
    transition: opacity 0.15s;
  }

  .sitenav{display:flex;gap:6px;align-items:center}
  .navbtn{font-family:'Space Mono',monospace;font-size:10px;padding:5px 12px;border:1px solid var(--border);color:var(--white);text-decoration:none;letter-spacing:2px;transition:all .15s}
  .navbtn:hover{border-color:var(--green);color:var(--green)}
  .navbtn.active{border-color:var(--green);color:var(--green);background:rgba(0,255,136,0.08)}
  .modetoggle{background:none;border:1px solid var(--border);color:var(--white);font-family:'Space Mono',monospace;font-size:10px;padding:5px 10px;cursor:pointer;letter-spacing:1px;transition:all .15s}
  .modetoggle:hover{border-color:var(--green);color:var(--green)}
  body.light{--black:#f5f5f0;--white:#111;--dim:#e8e5de;--border:#ccc;--text-dim:#bbb;--text-mid:#888}
  body.light svg{background:var(--black)}
  body.light .panel{background:var(--dim)}
</style>
</head>
<body>

<header>
  <div class="logo">LDS<span>.</span>GRAPH</div>
  <div class="hright">
    <div class="hstat"><div class="dot dot-amber"></div> SUPERSEDES</div>
    <div class="hstat"><div class="dot dot-blue"></div> RELATES_TO</div>
    <div class="hstat"><div class="dot dot-red"></div> REQUIRES</div>
    <div class="hstat"><div class="dot dot-purple"></div> IMPLIES</div>
    <div class="hstat"><div class="dot dot-dim"></div> GHOST</div>
    <div class="badge" id="nodecount">0 ENTITIES</div>
  </div>
  <nav class="sitenav">
    <a class="navbtn" href="index.html">BOUNCE</a>
    <a class="navbtn active" href="graph.html">GRAPH</a>
    <a class="navbtn" href="sandbox.html">SANDBOX</a>
    <button class="modetoggle" id="modetog" onclick="toggleMode()">◑</button>
  </nav>
</header>

<main>
  <div id="canvas">
    <svg id="svg"></svg>
    <div class="controls">
      <button class="ctrl-btn" onclick="zoomIn()">+</button>
      <button class="ctrl-btn" onclick="zoomOut()">−</button>
      <button class="ctrl-btn" onclick="resetZoom()" title="Reset">⌂</button>
      <button class="ctrl-btn" onclick="reheat()" title="Reheat simulation">↺</button>
    </div>
    <div class="tooltip" id="tooltip"></div>
  </div>

  <div class="panel">
    <div class="panel-head">
      <div class="panel-title" id="panel-title">SELECT NODE</div>
      <div class="panel-sub" id="panel-sub">Click an entity to inspect</div>
    </div>

    <div class="panel-body" id="panel-body">
      <div class="empty-panel">
        <div class="empty-big">GRAPH</div>
        <div>Select an entity node</div>
        <div style="color:var(--border);margin-top:4px;font-size:8px">to inspect its kernel data</div>
      </div>
    </div>

    <div class="legend">
      <div class="legend-title">Edge Types</div>
      <div class="legend-row">
        <div class="legend-line" style="background:var(--amber)"></div>
        <span>supersedes — version chain</span>
      </div>
      <div class="legend-row">
        <div class="legend-line" style="background:var(--blue);border-top:1px dashed var(--blue);height:0"></div>
        <span>relates_to — graph link</span>
      </div>
      <div class="legend-row">
        <div class="legend-line" style="background:var(--red);opacity:0.5"></div>
        <span>requires — dependency</span>
      </div>
      <div class="legend-row">
        <div class="legend-line" style="background:var(--purple);opacity:0.4"></div>
        <span>implies — inference</span>
      </div>
    </div>
  </div>
</main>

<script>
// ─── ENTITY DATA ────────────────────────────────────────────────────────────
const ENTITIES = [
  {
    "_lds": {
      "v": "0.1.0",
      "id": "lds:construction/assembly/supa-saint-integration-unit",
      "type": "structural_assembly",
      "created_at": "2022-01-01T12:00:00Z",
      "origin": "jenkintown-electricity"
    },
    "vectors": {
      "category": ["construction:glazing","assembly:composite","material:aluminum"],
      "spatial": { "bounds": [[0,0,0],[10,10,10]] },
      "temporal": { "install_phase": 4 }
    },
    "core": {
      "name": "Supa Saint Integration Unit",
      "manufacturer": "Jenkintown Electricity",
      "bom_structure": [
        {"role":"frame","material_type":"aluminum","quantity":1,"unit":"each"},
        {"role":"glazing","material_type":"low-iron-glass","quantity":2,"unit":"each"}
      ]
    },
    "inference": {
      "relates_to": ["lds:construction/assembly/supa-saint-integration-unit-2"],
      "requires": ["lds:construction/material/aluminum-6063"],
      "implies": ["lds:construction/assembly/supa-saint-integration-unit-implies"]
    }
  },
  {
    "_lds": {
      "v": "0.1.0",
      "id": "lds:construction/assembly/supa-saint-integration-unit-v2",
      "type": "mechanical_assembly",
      "created_at": "2026-02-18T00:00:00Z",
      "origin": "jenkintown-electricity",
      "supersedes": "lds:construction/assembly/supa-saint-integration-unit"
    },
    "vectors": {
      "category": ["construction:mechanical","assembly:integrated-systems","material:composite"],
      "spatial": { "bounds": [[0,0,0],[2400,1800,600]], "units": "millimeters" },
      "temporal": { "install_phase": 4 }
    },
    "core": {
      "name": "SUPA-SAINT Integration Unit",
      "manufacturer": "Jenkintown Electricity Corporation",
      "bom_structure": [
        {"role":"primary_controller","material_type":"industrial-grade-pcb","quantity":2,"unit":"units"},
        {"role":"power_distribution","material_type":"copper-bus-bar","quantity":48,"unit":"meters"},
        {"role":"structural_frame","material_type":"structural-steel","quantity":120,"unit":"kilograms"},
        {"role":"thermal_management","material_type":"aluminum-heat-sink","quantity":8,"unit":"pieces"},
        {"role":"signal_integrity","material_type":"shielded-cabling","quantity":500,"unit":"meters"}
      ]
    },
    "inference": {
      "relates_to": ["lds:construction/assembly/power-distribution-node","lds:construction/assembly/control-interface-module"],
      "requires": ["lds:construction/material/structural-steel","lds:construction/material/copper-conductors","lds:construction/component/industrial-controller"],
      "implies": ["lds:construction/assembly/field-installation-ready","lds:construction/assembly/commissioning-enabled"]
    }
  },
  {
    "_lds": {
      "v": "0.1.0",
      "id": "lds:construction/assembly/power-distribution-node",
      "type": "mechanical_assembly",
      "created_at": "2026-02-18T00:00:00Z",
      "origin": "jenkintown-electricity"
    },
    "vectors": {
      "category": ["construction:electrical","assembly:power-systems","material:copper"],
      "spatial": { "bounds": [[0,0,0],[800,1600,400]], "units": "millimeters" },
      "temporal": { "install_phase": 4 }
    },
    "core": {
      "name": "Power Distribution Node",
      "manufacturer": "Jenkintown Electricity Corporation",
      "bom_structure": [
        {"role":"main_bus","material_type":"copper-bus-bar","quantity":20,"unit":"meters"},
        {"role":"breaker_array","material_type":"molded-case-circuit-breaker","quantity":12,"unit":"units"},
        {"role":"enclosure","material_type":"powder-coated-steel","quantity":1,"unit":"unit"}
      ]
    },
    "inference": {
      "relates_to": ["lds:construction/assembly/supa-saint-integration-unit-v2"],
      "requires": ["lds:construction/material/copper-conductors","lds:construction/component/circuit-breaker"],
      "implies": ["lds:construction/assembly/field-installation-ready","lds:construction/assembly/high-current-capable"]
    }
  },
  {
    "_lds": {
      "v": "0.1.0",
      "id": "lds:validkernel/boundary/bounce-orchestrator-agent",
      "type": "agent_boundary",
      "created_at": "2026-02-18T00:00:00Z",
      "origin": "lefebvre-design-solutions"
    },
    "core": {
      "name": "Bounce Orchestrator Agent",
      "domain": "lds-entity-generation",
      "role": "l2-proposer"
    },
    "inference": {
      "allowed_actions": ["generate_lds_entity","validate_schema","propose_corrections"],
      "conflicts": ["modify_kernel_invariants","approve_own_output","escalate_without_validation"],
      "requires": ["schema_reference_present","l0_command_issued","l1_gate_active"],
      "relates_to": [],
      "implies": []
    }
  }
];

// ─── BUILD GRAPH ─────────────────────────────────────────────────────────────
function buildGraph(entities) {
  const nodeMap = new Map();
  const edges = [];

  // Register all known entities
  entities.forEach(e => {
    const id = e._lds.id;
    nodeMap.set(id, {
      id,
      entity: e,
      name: e.core?.name || id.split('/').pop(),
      type: e._lds.type,
      ghost: false
    });
  });

  // Build edges and register ghost nodes
  const addGhost = (id) => {
    if (!nodeMap.has(id)) {
      nodeMap.set(id, {
        id,
        entity: null,
        name: id.split('/').pop(),
        type: 'ghost',
        ghost: true
      });
    }
  };

  entities.forEach(e => {
    const src = e._lds.id;
    const inf = e.inference || {};

    if (e._lds.supersedes) {
      addGhost(e._lds.supersedes);
      edges.push({ source: src, target: e._lds.supersedes, type: 'supersedes' });
    }
    (inf.relates_to || []).forEach(t => {
      addGhost(t);
      edges.push({ source: src, target: t, type: 'relates_to' });
    });
    (inf.requires || []).forEach(t => {
      addGhost(t);
      edges.push({ source: src, target: t, type: 'requires' });
    });
    (inf.implies || []).forEach(t => {
      addGhost(t);
      edges.push({ source: src, target: t, type: 'implies' });
    });
  });

  return { nodes: Array.from(nodeMap.values()), edges };
}

// ─── COLOR MAP ───────────────────────────────────────────────────────────────
const TYPE_COLOR = {
  mechanical_assembly: '#00ff88',
  structural_assembly: '#ffaa00',
  agent_boundary:      '#aa44ff',
  ghost:               '#333333'
};

const EDGE_COLOR = {
  supersedes: '#ffaa00',
  relates_to: '#00aaff',
  requires:   '#ff2244',
  implies:    '#aa44ff'
};

// ─── INIT ────────────────────────────────────────────────────────────────────
const { nodes, edges } = buildGraph(ENTITIES);
document.getElementById('nodecount').textContent =
  ENTITIES.length + ' ENTITIES · ' + nodes.filter(n=>n.ghost).length + ' REFS';

const svgEl = document.getElementById('svg');
const W = () => svgEl.clientWidth;
const H = () => svgEl.clientHeight;

const svg = d3.select('#svg');

// Defs — markers
const defs = svg.append('defs');
['supersedes','relates_to','requires','implies'].forEach(type => {
  defs.append('marker')
    .attr('id', 'arrow-'+type)
    .attr('viewBox', '0 -4 8 8')
    .attr('refX', 20)
    .attr('refY', 0)
    .attr('markerWidth', 6)
    .attr('markerHeight', 6)
    .attr('orient', 'auto')
    .append('path')
    .attr('d', 'M0,-4L8,0L0,4')
    .attr('fill', EDGE_COLOR[type]);
});

// Zoom
const zoomBehavior = d3.zoom()
  .scaleExtent([0.2, 4])
  .on('zoom', e => g.attr('transform', e.transform));
svg.call(zoomBehavior);

const g = svg.append('g');

// Simulation
const sim = d3.forceSimulation(nodes)
  .force('link', d3.forceLink(edges).id(d => d.id).distance(d => {
    if (d.type === 'supersedes') return 140;
    if (d.type === 'relates_to') return 180;
    return 220;
  }).strength(d => {
    if (d.type === 'supersedes') return 0.8;
    if (d.type === 'relates_to') return 0.5;
    return 0.2;
  }))
  .force('charge', d3.forceManyBody().strength(d => d.ghost ? -80 : -200))
  .force('center', d3.forceCenter(500, 300))
  .force('collision', d3.forceCollide().radius(d => d.ghost ? 35 : 55));

// Draw edges
const edgeG = g.append('g').attr('class', 'edges');
const edgeSel = edgeG.selectAll('path')
  .data(edges)
  .join('path')
  .attr('class', d => 'edge edge-'+d.type)
  .attr('marker-end', d => 'url(#arrow-'+d.type+')')
  .style('stroke', d => EDGE_COLOR[d.type]);

// Draw nodes
const nodeG = g.append('g').attr('class', 'nodes');
const nodeSel = nodeG.selectAll('g')
  .data(nodes)
  .join('g')
  .attr('class', d => 'node'+(d.ghost?' node-ghost':''))
  .call(d3.drag()
    .on('start', dragStart)
    .on('drag', dragged)
    .on('end', dragEnd))
  .on('click', (event, d) => selectNode(d))
  .on('mouseenter', (event, d) => showTooltip(event, d))
  .on('mouseleave', hideTooltip);

// Pulse ring for real nodes
nodeSel.filter(d => !d.ghost).append('circle')
  .attr('class', 'pulse-ring')
  .attr('r', 28);

// Node body
nodeSel.append('circle')
  .attr('class', 'node-body')
  .attr('r', d => d.ghost ? 18 : 28)
  .attr('fill', d => d.ghost ? 'transparent' : TYPE_COLOR[d.type] || '#555')
  .attr('fill-opacity', d => d.ghost ? 0 : 0.08)
  .attr('stroke', d => d.ghost ? '#2a2a2a' : (TYPE_COLOR[d.type] || '#555'))
  .attr('stroke-dasharray', d => d.ghost ? '3,3' : null);

// Node ring
nodeSel.filter(d => !d.ghost).append('circle')
  .attr('class', 'node-ring')
  .attr('r', 34)
  .attr('stroke', d => TYPE_COLOR[d.type] || '#555');

// Node label
nodeSel.append('text')
  .attr('class', 'node-label')
  .attr('dy', d => d.ghost ? 3 : -4)
  .attr('font-size', d => d.ghost ? '8px' : '11px')
  .text(d => {
    const name = d.name.replace(/-/g,' ').toUpperCase();
    return name.length > 16 ? name.slice(0,14)+'…' : name;
  })
  .attr('fill', d => d.ghost ? '#333' : '#f0ede6');

// Type sublabel
nodeSel.filter(d => !d.ghost).append('text')
  .attr('class', 'node-sublabel')
  .attr('dy', 10)
  .text(d => d.type.replace(/_/g,'·').toUpperCase().slice(0,18))
  .attr('font-size', '6px');

// Tick
sim.on('tick', () => {
  edgeSel.attr('d', d => {
    const dx = d.target.x - d.source.x;
    const dy = d.target.y - d.source.y;
    const dr = Math.sqrt(dx*dx + dy*dy);
    // Curved paths for relates_to, straight for others
    if (d.type === 'relates_to') {
      return `M${d.source.x},${d.source.y}A${dr},${dr} 0 0,1 ${d.target.x},${d.target.y}`;
    }
    return `M${d.source.x},${d.source.y}L${d.target.x},${d.target.y}`;
  });

  nodeSel.attr('transform', d => `translate(${d.x},${d.y})`);
});

// ─── INTERACTION ─────────────────────────────────────────────────────────────
let selected = null;

function selectNode(d) {
  if (d.ghost) {
    renderGhostPanel(d);
    return;
  }
  selected = d;
  renderPanel(d);

  // Highlight
  nodeSel.select('.node-body')
    .attr('stroke-width', n => n.id === d.id ? 2.5 : 1.5)
    .attr('fill-opacity', n => n.id === d.id ? 0.18 : 0.08);

  edgeSel.style('opacity', e =>
    (e.source.id === d.id || e.target.id === d.id) ? 1 : 0.15
  );
}

function renderPanel(d) {
  const e = d.entity;
  document.getElementById('panel-title').textContent = d.name.toUpperCase();
  document.getElementById('panel-sub').textContent = e._lds.id;

  const body = document.getElementById('panel-body');
  const inf = e.inference || {};
  const vec = e.vectors || {};

  let html = '';

  // Identity
  html += `<div class="field-group">
    <div class="field-label">Identity</div>
    <div class="field-val green">${e._lds.id}</div>
    <div class="field-val">${e._lds.type}</div>
    <div class="field-val" style="color:var(--text-mid);font-size:8px">${e._lds.created_at || '—'}</div>
    <div class="field-val" style="color:var(--text-mid);font-size:8px">origin: ${e._lds.origin}</div>
  </div>`;

  if (e._lds.supersedes) {
    html += `<div class="field-group">
      <div class="field-label">Supersedes</div>
      <div class="field-val amber">${e._lds.supersedes}</div>
    </div>`;
  }

  if (vec.category?.length) {
    html += `<div class="field-group">
      <div class="field-label">Category Vectors</div>
      <div>${vec.category.map(c => `<span class="tag">${c}</span>`).join('')}</div>
    </div>`;
  }

  if (e.core?.bom_structure?.length) {
    html += `<div class="field-group">
      <div class="field-label">BOM (${e.core.bom_structure.length} items)</div>
      ${e.core.bom_structure.map(b => `
        <div class="bom-row">
          <div>
            <div class="bom-role">${b.role}</div>
            <div class="bom-mat">${b.material_type}</div>
          </div>
          <div class="bom-qty">${b.quantity} ${b.unit}</div>
        </div>`).join('')}
    </div>`;
  }

  // Boundary-specific
  if (e.core?.domain) {
    html += `<div class="field-group">
      <div class="field-label">Domain / Role</div>
      <div class="field-val purple">${e.core.domain}</div>
      <div class="field-val">${e.core.role}</div>
    </div>`;
  }

  if (inf.allowed_actions?.length) {
    html += `<div class="field-group">
      <div class="field-label">Allowed Actions</div>
      <div>${inf.allowed_actions.map(a => `<span class="tag">${a}</span>`).join('')}</div>
    </div>`;
  }

  if (inf.conflicts?.length) {
    html += `<div class="field-group">
      <div class="field-label">Conflicts (Prohibited)</div>
      <div>${inf.conflicts.map(a => `<span class="tag tag-red">${a}</span>`).join('')}</div>
    </div>`;
  }

  if (inf.relates_to?.length) {
    html += `<div class="field-group">
      <div class="field-label">Relates To</div>
      <div>${inf.relates_to.map(r => `<span class="tag tag-blue">${r.split('/').pop()}</span>`).join('')}</div>
    </div>`;
  }

  if (inf.requires?.length) {
    html += `<div class="field-group">
      <div class="field-label">Requires</div>
      <div>${inf.requires.map(r => `<span class="tag tag-red">${r.split('/').pop()}</span>`).join('')}</div>
    </div>`;
  }

  if (inf.implies?.length) {
    html += `<div class="field-group">
      <div class="field-label">Implies</div>
      <div>${inf.implies.map(r => `<span class="tag tag-purple">${r.split('/').pop()}</span>`).join('')}</div>
    </div>`;
  }

  body.innerHTML = html;
}

function renderGhostPanel(d) {
  document.getElementById('panel-title').textContent = 'GHOST NODE';
  document.getElementById('panel-sub').textContent = d.id;
  document.getElementById('panel-body').innerHTML = `
    <div class="field-group">
      <div class="field-label">Status</div>
      <div class="field-val amber">Referenced but not yet generated</div>
    </div>
    <div class="field-group">
      <div class="field-label">ID</div>
      <div class="field-val" style="font-size:8px">${d.id}</div>
    </div>
    <div class="field-group">
      <div class="field-label">Action Required</div>
      <div class="field-val" style="color:var(--text-mid);font-size:9px">
        Run a bounce command to generate this entity and close the dangling reference.
      </div>
    </div>`;
}

function showTooltip(event, d) {
  const t = document.getElementById('tooltip');
  t.style.left = (event.offsetX + 12) + 'px';
  t.style.top = (event.offsetY - 12) + 'px';
  t.innerHTML = d.ghost
    ? `<span style="color:var(--amber)">GHOST</span><br>${d.id}`
    : `<span style="color:var(--green)">${d.name}</span><br><span style="color:var(--text-mid)">${d.type}</span>`;
  t.style.opacity = 1;
}

function hideTooltip() {
  document.getElementById('tooltip').style.opacity = 0;
}

// Drag
function dragStart(event, d) {
  if (!event.active) sim.alphaTarget(0.3).restart();
  d.fx = d.x; d.fy = d.y;
}
function dragged(event, d) {
  d.fx = event.x; d.fy = event.y;
}
function dragEnd(event, d) {
  if (!event.active) sim.alphaTarget(0);
  d.fx = null; d.fy = null;
}

// Zoom controls
function zoomIn() { svg.transition().call(zoomBehavior.scaleBy, 1.4); }
function zoomOut() { svg.transition().call(zoomBehavior.scaleBy, 0.7); }
function resetZoom() {
  svg.transition().call(zoomBehavior.transform,
    d3.zoomIdentity.translate(W()/2, H()/2).scale(0.85));
}
function reheat() { sim.alpha(0.5).restart(); }

// Center on load
setTimeout(() => {
  resetZoom();
}, 800);

function toggleMode(){
  document.body.classList.toggle('light');
  document.getElementById('modetog').textContent=document.body.classList.contains('light')?'●':'◑';
  localStorage.setItem('vk-theme',document.body.classList.contains('light')?'light':'dark');
}
if(localStorage.getItem('vk-theme')==='light'){document.body.classList.add('light');setTimeout(()=>{document.getElementById('modetog').textContent='●'},0)}
</script>
</body>
</html>
