<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>SCHEMAS — ValidKernel</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Space+Mono:wght@400;700&family=Bebas+Neue&family=DM+Sans:wght@300;400;500&display=swap');
  :root{--black:#080808;--white:#f0ede6;--green:#00ff88;--red:#ff2244;--amber:#ffaa00;--dim:#111;--border:#222;--text-dim:#444}
  *{margin:0;padding:0;box-sizing:border-box}
  body{background:var(--black);color:var(--white);font-family:'DM Sans',sans-serif;min-height:100vh;display:grid;grid-template-rows:auto 1fr auto}
  header{border-bottom:1px solid var(--border);padding:14px 28px;display:flex;align-items:center;justify-content:space-between;position:sticky;top:0;background:var(--black);z-index:100}
  .logo{font-family:'Bebas Neue',sans-serif;font-size:26px;letter-spacing:5px}.logo span{color:var(--green)}
  .sitenav{display:flex;gap:6px;align-items:center}
  .navbtn{font-family:'Space Mono',monospace;font-size:10px;padding:5px 12px;border:1px solid var(--border);color:var(--white);text-decoration:none;letter-spacing:2px;transition:all .15s}
  .navbtn:hover{border-color:var(--green);color:var(--green)}
  .navbtn.active{border-color:var(--green);color:var(--green);background:rgba(0,255,136,0.08)}
  .modetoggle{background:none;border:1px solid var(--border);color:var(--white);font-family:'Space Mono',monospace;font-size:10px;padding:5px 10px;cursor:pointer;letter-spacing:1px}
  .modetoggle:hover{border-color:var(--green);color:var(--green)}

  main{display:grid;grid-template-columns:340px 1fr;height:calc(100vh - 53px - 40px);overflow:hidden}
  /* LEFT — schema list */
  .sleft{border-right:1px solid var(--border);display:flex;flex-direction:column;overflow:hidden}
  .shead{padding:14px 18px 10px;border-bottom:1px solid var(--border);font-family:'Space Mono',monospace;font-size:9px;color:var(--text-dim);letter-spacing:2px;text-transform:uppercase}
  .shead strong{display:block;color:var(--white);font-size:12px;margin-bottom:3px}
  .slist{flex:1;overflow-y:auto;padding:8px 0}
  .slist::-webkit-scrollbar{width:2px}.slist::-webkit-scrollbar-thumb{background:var(--border)}
  .sitem{padding:10px 18px;border-bottom:1px solid #111;cursor:pointer;transition:background .12s;display:flex;align-items:center;justify-content:space-between}
  .sitem:hover{background:rgba(255,255,255,.02)}
  .sitem.active{background:rgba(0,255,136,.04);border-left:2px solid var(--green)}
  .sitem-name{font-family:'Space Mono',monospace;font-size:10px;color:var(--white)}
  .sitem-meta{font-size:8px;color:var(--text-dim);margin-top:2px}
  .sitem-del{background:none;border:none;color:var(--text-dim);font-size:12px;cursor:pointer;padding:2px 4px}
  .sitem-del:hover{color:var(--red)}
  .sfoot{padding:12px 18px;border-top:1px solid var(--border);display:flex;gap:6px}
  .sbtn{flex:1;background:none;border:1px solid var(--border);color:var(--white);font-family:'Space Mono',monospace;font-size:9px;padding:7px;cursor:pointer;letter-spacing:1px;transition:all .15s}
  .sbtn:hover{border-color:var(--green);color:var(--green)}
  .sbtn.primary{background:var(--green);color:var(--black);border-color:var(--green)}
  .sbtn.primary:hover{background:var(--white)}

  /* RIGHT — schema editor */
  .sright{display:flex;flex-direction:column;overflow:hidden}
  .ehead{padding:14px 24px 10px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;flex-shrink:0}
  .etitle{font-family:'Bebas Neue',sans-serif;font-size:20px;letter-spacing:3px}
  .esubtitle{font-family:'Space Mono',monospace;font-size:8px;color:var(--text-dim);margin-top:2px}
  .ebody{flex:1;overflow-y:auto;padding:20px 24px;display:flex;flex-direction:column;gap:16px}
  .ebody::-webkit-scrollbar{width:3px}.ebody::-webkit-scrollbar-thumb{background:var(--border)}
  .erow{display:flex;flex-direction:column;gap:4px}
  .elabel{font-family:'Space Mono',monospace;font-size:9px;color:var(--text-dim);letter-spacing:1px;text-transform:uppercase}
  .einput{background:var(--dim);border:1px solid var(--border);color:var(--white);font-family:'DM Sans',sans-serif;font-size:13px;padding:8px 10px;outline:none;width:100%}
  .einput:focus{border-color:var(--green)}
  .einput::placeholder{color:var(--text-dim)}
  /* Field table */
  .ftable{display:flex;flex-direction:column;gap:0;border:1px solid var(--border)}
  .frow{display:grid;grid-template-columns:1fr 100px 80px 32px;align-items:center;border-bottom:1px solid var(--border);background:var(--dim)}
  .frow:last-child{border-bottom:none}
  .frow.fhead{background:#0c0c0c;grid-template-columns:1fr 100px 80px 32px}
  .fcell{font-family:'Space Mono',monospace;font-size:8px;color:var(--text-dim);padding:6px 8px;letter-spacing:1px;text-transform:uppercase}
  .finput{background:transparent;border:none;border-right:1px solid var(--border);color:var(--white);font-family:'Space Mono',monospace;font-size:9px;padding:7px 8px;outline:none;width:100%}
  .finput:focus{background:rgba(0,255,136,.03)}
  .finput::placeholder{color:#333}
  .fsel{background:transparent;border:none;border-right:1px solid var(--border);color:var(--white);font-family:'Space Mono',monospace;font-size:9px;padding:7px 6px;outline:none;width:100%;cursor:pointer}
  option{background:#111}
  .fchk{display:flex;align-items:center;justify-content:center;padding:7px}
  .fchk input[type=checkbox]{accent-color:var(--green);width:14px;height:14px;cursor:pointer}
  .fdel{background:none;border:none;color:var(--text-dim);font-size:13px;cursor:pointer;padding:6px;width:100%;display:flex;align-items:center;justify-content:center}
  .fdel:hover{color:var(--red)}
  .addrow-btn{background:none;border:1px dashed var(--border);color:var(--text-dim);font-family:'Space Mono',monospace;font-size:9px;padding:8px;cursor:pointer;letter-spacing:1px;width:100%;transition:all .15s}
  .addrow-btn:hover{border-color:var(--green);color:var(--green)}
  /* Version badge */
  .vbadge{font-family:'Space Mono',monospace;font-size:8px;padding:3px 8px;background:rgba(0,255,136,.1);color:var(--green);letter-spacing:1px}
  /* System prompt preview */
  .sys-preview{background:#050505;border:1px solid var(--border);padding:10px;font-family:'Space Mono',monospace;font-size:8px;color:#555;line-height:1.6;max-height:80px;overflow-y:auto;white-space:pre-wrap}
  .efoot{padding:12px 24px;border-top:1px solid var(--border);display:flex;gap:8px;flex-shrink:0}
  /* Empty state */
  .empty-editor{flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:12px;color:var(--text-dim);font-family:'Space Mono',monospace;font-size:11px;text-align:center}
  .ebig{font-family:'Bebas Neue',sans-serif;font-size:56px;color:var(--border);line-height:1;letter-spacing:5px}

  footer{border-top:1px solid var(--border);padding:8px 28px;display:flex;align-items:center;justify-content:space-between;font-family:'Space Mono',monospace;font-size:9px;color:var(--text-dim)}
  body.light{--black:#f5f5f0;--white:#111;--dim:#e8e5de;--border:#ccc;--text-dim:#bbb}
  body.light header,body.light footer{background:var(--black)}
</style>
</head>
<body>

<header>
  <div class="logo">SCHEMA<span>.</span></div>
  <nav class="sitenav">
    <a class="navbtn" href="index.html">BOUNCE</a>
    <a class="navbtn" href="graph.html">GRAPH</a>
    <a class="navbtn" href="sandbox.html">SANDBOX</a>
    <a class="navbtn active" href="schema.html">SCHEMAS</a>
    <button class="modetoggle" id="modetog" onclick="toggleMode()">◑</button>
  </nav>
</header>

<main>
  <div class="sleft">
    <div class="shead"><strong>CUSTOM SCHEMAS</strong>User-defined · localStorage</div>
    <div class="slist" id="slist"></div>
    <div class="sfoot">
      <button class="sbtn primary" onclick="newSchema()">+ NEW</button>
      <button class="sbtn" onclick="exportAll()">EXPORT</button>
      <button class="sbtn" onclick="document.getElementById('simport').click()">IMPORT</button>
    </div>
    <input type="file" id="simport" accept=".json" style="display:none" onchange="importSchemas(event)">
  </div>

  <div class="sright" id="sright">
    <div class="empty-editor" id="emptyEditor">
      <div class="ebig">SCHEMAS</div>
      <div>Define required fields, types, and shapes</div>
      <div style="color:var(--border);margin-top:4px">Custom schemas inject into BOUNCE automatically</div>
      <button class="sbtn primary" style="margin-top:16px;padding:10px 24px;font-size:13px;letter-spacing:3px" onclick="newSchema()">+ CREATE SCHEMA</button>
    </div>
    <div id="editor" style="display:none;flex-direction:column;height:100%">
      <div class="ehead">
        <div>
          <div class="etitle" id="etitle">NEW SCHEMA</div>
          <div class="esubtitle" id="esubtitle">Unsaved</div>
        </div>
        <span class="vbadge" id="evbadge">v1</span>
      </div>
      <div class="ebody">
        <div class="erow">
          <div class="elabel">Schema Name</div>
          <input class="einput" id="ename" placeholder="e.g. HVAC Equipment" oninput="onNameChange()">
        </div>
        <div class="erow">
          <div class="elabel">Description</div>
          <input class="einput" id="edesc" placeholder="Optional description">
        </div>
        <div class="erow">
          <div class="elabel">Required Fields</div>
          <div class="ftable">
            <div class="frow fhead">
              <div class="fcell">Field Path</div>
              <div class="fcell">Type</div>
              <div class="fcell">Required</div>
              <div class="fcell"></div>
            </div>
            <div id="frows"></div>
          </div>
          <button class="addrow-btn" onclick="addField()">+ ADD FIELD</button>
        </div>
        <div class="erow">
          <div class="elabel">System Prompt Preview</div>
          <div class="sys-preview" id="sysprev"></div>
        </div>
      </div>
      <div class="efoot">
        <button class="sbtn primary" onclick="saveSchema()">SAVE SCHEMA</button>
        <button class="sbtn" onclick="bumpVersion()">BUMP VERSION</button>
        <button class="sbtn" onclick="exportOne()">EXPORT</button>
        <button class="sbtn" style="color:var(--red);border-color:var(--red)" onclick="deleteCurrentSchema()">DELETE</button>
      </div>
    </div>
  </div>
</main>

<footer>
  <span>VALIDKERNEL / LEFEBVRE DESIGN SOLUTIONS</span>
  <span id="schemaCount">0 custom schemas</span>
  <span>SCHEMA BUILDER</span>
</footer>

<script>
const SCHEMA_KEY = 'vk-custom-schemas-v1';
let schemas = [];
let currentId = null;
// Editing state — in-memory before save
let draft = null;

function load() {
  try { schemas = JSON.parse(localStorage.getItem(SCHEMA_KEY) || '[]'); }
  catch(e) { schemas = []; }
}

function save() {
  localStorage.setItem(SCHEMA_KEY, JSON.stringify(schemas));
  updateCount();
}

function updateCount() {
  document.getElementById('schemaCount').textContent = schemas.length + ' custom schema' + (schemas.length===1?'':'s');
}

function genId() { return Date.now().toString(36).toUpperCase(); }

function renderList() {
  const list = document.getElementById('slist');
  if (!schemas.length) {
    list.innerHTML = '<div style="padding:20px;text-align:center;color:var(--text-dim);font-size:9px;font-family:Space Mono,monospace">NO CUSTOM SCHEMAS</div>';
    return;
  }
  list.innerHTML = schemas.map(s => `
    <div class="sitem ${currentId===s.id?'active':''}" onclick="editSchema('${s.id}')">
      <div>
        <div class="sitem-name">${esc(s.name)}</div>
        <div class="sitem-meta">v${s.version} · ${s.fields.length} fields · ${s.fields.filter(f=>f.required).length} required</div>
      </div>
      <button class="sitem-del" onclick="event.stopPropagation();confirmDelete('${s.id}')">✕</button>
    </div>`).join('');
}

function newSchema() {
  currentId = null;
  draft = {
    id: genId(),
    name: '',
    description: '',
    version: 1,
    fields: [
      { path:'_lds.v', type:'string', required:true },
      { path:'_lds.id', type:'string', required:true },
      { path:'_lds.type', type:'string', required:true },
    ]
  };
  renderEditor();
}

function editSchema(id) {
  currentId = id;
  const s = schemas.find(x=>x.id===id);
  if (!s) return;
  draft = JSON.parse(JSON.stringify(s)); // deep copy
  renderEditor();
  renderList();
}

function renderEditor() {
  document.getElementById('emptyEditor').style.display = 'none';
  const ed = document.getElementById('editor');
  ed.style.display = 'flex';
  document.getElementById('ename').value = draft.name || '';
  document.getElementById('edesc').value = draft.description || '';
  document.getElementById('etitle').textContent = draft.name || 'NEW SCHEMA';
  document.getElementById('esubtitle').textContent = currentId ? 'Editing · id: '+draft.id : 'New schema — not saved yet';
  document.getElementById('evbadge').textContent = 'v'+draft.version;
  renderFields();
  updateSysPreview();
}

function renderFields() {
  const container = document.getElementById('frows');
  container.innerHTML = draft.fields.map((f, i) => `
    <div class="frow" id="frow${i}">
      <input class="finput" value="${esc(f.path)}" placeholder="e.g. core.name" onchange="updateField(${i},'path',this.value)" oninput="updateField(${i},'path',this.value)">
      <select class="fsel" onchange="updateField(${i},'type',this.value)">
        ${['string','number','boolean','array','object','any'].map(t=>`<option value="${t}" ${f.type===t?'selected':''}>${t}</option>`).join('')}
      </select>
      <div class="fchk"><input type="checkbox" ${f.required?'checked':''} onchange="updateField(${i},'required',this.checked)"></div>
      <button class="fdel" onclick="removeField(${i})">✕</button>
    </div>`).join('');
}

function updateField(i, key, val) {
  if (!draft || !draft.fields[i]) return;
  draft.fields[i][key] = val;
  if (key === 'path') updateSysPreview();
}

function addField() {
  draft.fields.push({ path:'', type:'string', required:false });
  renderFields();
  // Focus last path input
  setTimeout(() => {
    const rows = document.querySelectorAll('#frows .frow');
    const last = rows[rows.length-1];
    if (last) last.querySelector('.finput').focus();
  }, 30);
}

function removeField(i) {
  draft.fields.splice(i, 1);
  renderFields();
  updateSysPreview();
}

function onNameChange() {
  if (!draft) return;
  draft.name = document.getElementById('ename').value;
  document.getElementById('etitle').textContent = draft.name || 'NEW SCHEMA';
  updateSysPreview();
}

function updateSysPreview() {
  if (!draft) return;
  const req = draft.fields.filter(f=>f.required&&f.path).map(f=>f.path+' ('+f.type+')');
  const preview = `You are a precise JSON entity generator. Follow the schema exactly.\nSchema: ${draft.name||'(unnamed)'}\nRequired fields: ${req.length?req.join(', '):'(none defined)'}\nOutput ONLY raw JSON. Start with {. End with }. No markdown.`;
  document.getElementById('sysprev').textContent = preview;
}

function saveSchema() {
  if (!draft) return;
  draft.name = document.getElementById('ename').value.trim() || 'Unnamed Schema';
  draft.description = document.getElementById('edesc').value.trim();
  // Clean empty field paths
  draft.fields = draft.fields.filter(f => f.path.trim());

  const existing = schemas.findIndex(s=>s.id===draft.id);
  if (existing >= 0) {
    schemas[existing] = { ...draft };
  } else {
    schemas.unshift({ ...draft });
  }
  currentId = draft.id;
  save();
  renderList();
  renderEditor();
  // Flash feedback
  const btn = document.querySelector('.efoot .sbtn.primary');
  const orig = btn.textContent;
  btn.textContent = '✓ SAVED';
  btn.style.background='var(--green)';
  setTimeout(()=>{btn.textContent=orig;btn.style.background='';},1200);
}

function bumpVersion() {
  if (!draft) return;
  // Save first if not saved
  draft.version = (draft.version||1) + 1;
  document.getElementById('evbadge').textContent = 'v'+draft.version;
  document.getElementById('esubtitle').textContent = `Version bumped to v${draft.version} — save to commit`;
}

function confirmDelete(id) {
  const s = schemas.find(x=>x.id===id);
  if (!s) return;
  if (!confirm(`Delete schema "${s.name}"? This cannot be undone.`)) return;
  schemas = schemas.filter(x=>x.id!==id);
  save();
  if (currentId === id) {
    currentId = null;
    draft = null;
    document.getElementById('emptyEditor').style.display = 'flex';
    document.getElementById('editor').style.display = 'none';
  }
  renderList();
}

function deleteCurrentSchema() {
  if (!currentId) { alert('Save schema first.'); return; }
  confirmDelete(currentId);
}

function exportAll() {
  if (!schemas.length) { alert('No custom schemas to export.'); return; }
  const blob = new Blob([JSON.stringify(schemas, null, 2)], {type:'application/json'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href=url; a.download='vk-schemas-'+Date.now().toString(36).toUpperCase()+'.json';
  a.click(); URL.revokeObjectURL(url);
}

function exportOne() {
  if (!draft) return;
  const blob = new Blob([JSON.stringify(draft, null, 2)], {type:'application/json'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href=url; a.download='schema-'+draft.id+'.json';
  a.click(); URL.revokeObjectURL(url);
}

function importSchemas(event) {
  const file = event.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = e => {
    try {
      let imported = JSON.parse(e.target.result);
      if (!Array.isArray(imported)) imported = [imported];
      const existingIds = new Set(schemas.map(s=>s.id));
      let added = 0;
      for (const s of imported) {
        if (s.id && s.name && Array.isArray(s.fields)) {
          if (!existingIds.has(s.id)) { schemas.unshift(s); added++; }
        }
      }
      save();
      renderList();
      alert(`Imported ${added} schema(s).`);
    } catch(ex) { alert('Import failed: '+ex.message); }
  };
  reader.readAsText(file);
  event.target.value = '';
}

function esc(s){return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;')}

function toggleMode(){
  document.body.classList.toggle('light');
  const tog=document.getElementById('modetog');
  tog.textContent=document.body.classList.contains('light')?'●':'◑';
  localStorage.setItem('vk-theme',document.body.classList.contains('light')?'light':'dark');
}
if(localStorage.getItem('vk-theme')==='light'){document.body.classList.add('light');document.getElementById('modetog').textContent='●'}

// Init
load();
renderList();
updateCount();
</script>
</body>
</html>
