<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>BOUNCE — ValidKernel Orchestrator</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Space+Mono:wght@400;700&family=Bebas+Neue&family=DM+Sans:wght@300;400;500&display=swap');
  :root{--black:#080808;--white:#f0ede6;--green:#00ff88;--red:#ff2244;--amber:#ffaa00;--dim:#111;--border:#222;--text-dim:#444}
  *{margin:0;padding:0;box-sizing:border-box}
  body{background:var(--black);color:var(--white);font-family:'DM Sans',sans-serif;min-height:100vh;display:grid;grid-template-rows:auto 1fr auto;overflow-x:hidden}
  header{border-bottom:1px solid var(--border);padding:14px 28px;display:flex;align-items:center;justify-content:space-between;position:sticky;top:0;background:var(--black);z-index:100}
  .logo{font-family:'Bebas Neue',sans-serif;font-size:26px;letter-spacing:5px}.logo span{color:var(--green)}
  .hstatus{display:flex;gap:20px;align-items:center;font-family:'Space Mono',monospace;font-size:10px;color:var(--text-dim)}
  .dot{width:7px;height:7px;border-radius:50%;background:var(--border);display:inline-block;margin-right:5px;vertical-align:middle}
  .dot.live{background:var(--green);animation:pulse 1.5s infinite}.dot.err{background:var(--red)}
  @keyframes pulse{0%,100%{opacity:1}50%{opacity:.3}}
  main{display:grid;grid-template-columns:360px 1fr;height:calc(100vh - 53px - 40px);overflow:hidden}
  .pleft{border-right:1px solid var(--border);display:flex;flex-direction:column;overflow:hidden}
  .phead{padding:16px 20px 12px;border-bottom:1px solid var(--border);font-family:'Space Mono',monospace;font-size:9px;color:var(--text-dim);letter-spacing:2px;text-transform:uppercase}
  .phead strong{display:block;color:var(--white);font-size:12px;margin-bottom:3px;letter-spacing:1px}
  .aconf{padding:14px 20px;border-bottom:1px solid var(--border);display:flex;flex-direction:column;gap:8px}
  .arow{display:flex;align-items:center;gap:8px}
  .alabel{font-family:'Space Mono',monospace;font-size:9px;color:var(--text-dim);width:72px;flex-shrink:0;letter-spacing:1px}
  .alabel.ok{color:var(--green)}
  input.akey{flex:1;background:var(--dim);border:1px solid var(--border);color:var(--white);font-family:'Space Mono',monospace;font-size:10px;padding:6px 9px;outline:none;border-radius:2px}
  input.akey:focus{border-color:var(--green)}
  .carea{flex:1;padding:16px 20px;display:flex;flex-direction:column;gap:12px;overflow-y:auto}
  .clabel{font-family:'Space Mono',monospace;font-size:9px;color:var(--text-dim);letter-spacing:2px;text-transform:uppercase}
  textarea{flex:1;min-height:120px;background:var(--dim);border:1px solid var(--border);color:var(--white);font-family:'DM Sans',sans-serif;font-size:13px;line-height:1.6;padding:12px;resize:none;outline:none;border-radius:2px}
  textarea:focus{border-color:var(--green)}
  textarea::placeholder{color:var(--text-dim)}
  select.ssel{width:100%;background:var(--dim);border:1px solid var(--border);color:var(--white);font-family:'Space Mono',monospace;font-size:10px;padding:7px 9px;outline:none;cursor:pointer;border-radius:2px}
  select.ssel:focus{border-color:var(--green)}
  .sgrid{display:grid;grid-template-columns:1fr 1fr;gap:8px}
  .sblock{background:var(--dim);border:1px solid var(--border);padding:10px;border-radius:2px}
  .sblabel{font-family:'Space Mono',monospace;font-size:8px;color:var(--text-dim);letter-spacing:1px;text-transform:uppercase;margin-bottom:4px}
  .sbval{font-family:'Bebas Neue',sans-serif;font-size:20px;color:var(--green)}
  .sctrl{display:flex;gap:3px;margin-top:3px}
  .bsm{background:none;border:1px solid var(--border);color:var(--white);font-family:'Space Mono',monospace;font-size:11px;width:22px;height:22px;cursor:pointer;display:flex;align-items:center;justify-content:center;border-radius:2px}
  .bsm:hover{border-color:var(--green);color:var(--green)}
  .btnlaunch{width:100%;padding:14px;background:var(--green);color:var(--black);border:none;font-family:'Bebas Neue',sans-serif;font-size:20px;letter-spacing:4px;cursor:pointer;transition:all .15s;border-radius:2px}
  .btnlaunch:hover{background:var(--white)}.btnlaunch:disabled{background:var(--dim);color:var(--text-dim);cursor:not-allowed}
  .pright{display:flex;flex-direction:column;overflow:hidden}
  .bhead{padding:16px 24px 12px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;flex-shrink:0}
  .btitle{font-family:'Space Mono',monospace;font-size:9px;color:var(--text-dim);letter-spacing:2px;text-transform:uppercase}
  .btitle strong{display:block;color:var(--white);font-size:12px;margin-bottom:3px}
  .cblock{display:flex;align-items:center;gap:12px}
  .cscore{font-family:'Bebas Neue',sans-serif;font-size:38px;color:var(--green);line-height:1;min-width:70px;text-align:right}
  .cbwrap{flex:1;max-width:180px}
  .cblabel{font-family:'Space Mono',monospace;font-size:8px;color:var(--text-dim);letter-spacing:1px;margin-bottom:5px}
  .cbar{height:3px;background:var(--dim);border-radius:2px;overflow:hidden}
  .cfill{height:100%;background:var(--green);width:0%;transition:width .5s ease,background .3s;border-radius:2px}
  .blog{flex:1;overflow-y:auto;padding:16px 24px;display:flex;flex-direction:column;gap:10px}
  .blog::-webkit-scrollbar{width:3px}.blog::-webkit-scrollbar-track{background:var(--black)}.blog::-webkit-scrollbar-thumb{background:var(--border)}
  .bcard{background:var(--dim);border:1px solid var(--border);border-radius:2px;overflow:hidden;animation:slin .25s ease;border-left:3px solid var(--border)}
  .bcard.pass{border-left-color:var(--green)}.bcard.fail{border-left-color:var(--red)}.bcard.gate{border-left-color:var(--amber)}.bcard.converged{border:2px solid var(--green)}
  @keyframes slin{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:translateY(0)}}
  .ch{padding:10px 14px;display:flex;align-items:center;justify-content:space-between;cursor:pointer;user-select:none}
  .ch:hover{background:rgba(255,255,255,.02)}
  .cmeta{display:flex;align-items:center;gap:8px}
  .cnum{font-family:'Bebas Neue',sans-serif;font-size:16px;color:var(--text-dim);min-width:28px}
  .cmod{font-family:'Space Mono',monospace;font-size:10px;color:var(--white)}
  .crole{font-family:'Space Mono',monospace;font-size:8px;color:var(--text-dim);letter-spacing:1px;text-transform:uppercase}
  .cst{font-family:'Space Mono',monospace;font-size:9px;padding:2px 7px;border-radius:2px;letter-spacing:1px}
  .cst.PASS{background:rgba(0,255,136,.12);color:var(--green)}.cst.FAIL{background:rgba(255,34,68,.12);color:var(--red)}.cst.GATE{background:rgba(255,170,0,.12);color:var(--amber)}.cst.RUNNING{background:rgba(255,255,255,.04);color:var(--text-dim)}
  .cscr{font-family:'Space Mono',monospace;font-size:10px;color:var(--green)}
  .cbody{padding:12px 14px;display:none}
  .cbody.open{display:block}
  .cbody pre{font-family:'Space Mono',monospace;font-size:10px;line-height:1.65;color:#888;white-space:pre-wrap;word-break:break-word}
  .empty{flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:12px;color:var(--text-dim);font-family:'Space Mono',monospace;font-size:11px;text-align:center;padding:40px}
  .ebig{font-family:'Bebas Neue',sans-serif;font-size:64px;color:var(--border);line-height:1;letter-spacing:5px}
  .apanel{border-top:1px solid var(--border);padding:16px 24px;display:none;background:rgba(0,255,136,.02);flex-shrink:0}
  .apanel.vis{display:block}
  .atitle{font-family:'Space Mono',monospace;font-size:9px;color:var(--amber);letter-spacing:2px;text-transform:uppercase;margin-bottom:10px}
  .aout{background:var(--dim);border:1px solid var(--border);padding:12px;font-family:'Space Mono',monospace;font-size:10px;line-height:1.6;color:var(--white);max-height:130px;overflow-y:auto;white-space:pre-wrap;word-break:break-word;margin-bottom:12px;border-radius:2px}
  .abuts{display:flex;gap:10px}
  .bapprove{flex:1;padding:10px;background:var(--green);color:var(--black);border:none;font-family:'Bebas Neue',sans-serif;font-size:16px;letter-spacing:3px;cursor:pointer;border-radius:2px;transition:all .15s}
  .bapprove:hover{background:var(--white)}
  .bdeny{flex:1;padding:10px;background:none;color:var(--red);border:1px solid var(--red);font-family:'Bebas Neue',sans-serif;font-size:16px;letter-spacing:3px;cursor:pointer;border-radius:2px;transition:all .15s}
  .bdeny:hover{background:rgba(255,34,68,.08)}
  .bredirect{flex:1;padding:10px;background:none;color:var(--amber);border:1px solid var(--amber);font-family:'Bebas Neue',sans-serif;font-size:16px;letter-spacing:3px;cursor:pointer;border-radius:2px;transition:all .15s}
  .bredirect:hover{background:rgba(255,170,0,.08)}
  footer{border-top:1px solid var(--border);padding:8px 28px;display:flex;align-items:center;justify-content:space-between;font-family:'Space Mono',monospace;font-size:9px;color:var(--text-dim)}
  .carea::-webkit-scrollbar{width:3px}.carea::-webkit-scrollbar-track{background:var(--black)}.carea::-webkit-scrollbar-thumb{background:var(--border)}

  .sitenav{display:flex;gap:6px;align-items:center}
  .navbtn{font-family:'Space Mono',monospace;font-size:10px;padding:5px 12px;border:1px solid var(--border);color:var(--white);text-decoration:none;letter-spacing:2px;transition:all .15s}
  .navbtn:hover{border-color:var(--green);color:var(--green)}
  .navbtn.active{border-color:var(--green);color:var(--green);background:rgba(0,255,136,0.08)}
  .modetoggle{background:none;border:1px solid var(--border);color:var(--white);font-family:'Space Mono',monospace;font-size:10px;padding:5px 10px;cursor:pointer;letter-spacing:1px;transition:all .15s}
  .modetoggle:hover{border-color:var(--green);color:var(--green)}
  body.light{--black:#f5f5f0;--white:#111;--dim:#e8e5de;--border:#ccc;--text-dim:#bbb;--text-mid:#888}
  body.light header,body.light footer{background:var(--black)}
  body.light .pleft,body.light .pright{background:var(--black)}
  body.light input.akey{background:var(--dim);color:var(--white)}
  body.light textarea{background:var(--dim);color:var(--white)}
  body.light select.ssel{background:var(--dim);color:var(--white)}
  body.light .bcard{background:var(--dim)}
  body.light .apanel{background:rgba(0,0,0,0.03)}
  body.light .aout{background:var(--dim);color:var(--white)}
  body.light .sblock{background:var(--dim)}

  /* ── HISTORY DRAWER ─────────────────────────── */
  .hdrw{position:fixed;top:0;left:0;width:320px;height:100vh;background:#0a0a0a;border-right:1px solid var(--border);z-index:200;display:flex;flex-direction:column;transform:translateX(-100%);transition:transform .25s ease}
  .hdrw.open{transform:translateX(0)}
  .hdrw-head{padding:14px 16px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;flex-shrink:0}
  .hdrw-title{font-family:'Bebas Neue',sans-serif;font-size:18px;letter-spacing:4px;color:var(--green)}
  .hdrw-close{background:none;border:1px solid var(--border);color:var(--white);font-family:'Space Mono',monospace;font-size:11px;padding:4px 8px;cursor:pointer}
  .hdrw-close:hover{border-color:var(--red);color:var(--red)}
  .hdrw-search{padding:10px 16px;border-bottom:1px solid var(--border);flex-shrink:0}
  .hdrw-search input{width:100%;background:var(--dim);border:1px solid var(--border);color:var(--white);font-family:'Space Mono',monospace;font-size:10px;padding:6px 9px;outline:none}
  .hdrw-search input:focus{border-color:var(--green)}
  .hdrw-search input::placeholder{color:var(--text-dim)}
  .hdrw-list{flex:1;overflow-y:auto;padding:8px 0}
  .hdrw-list::-webkit-scrollbar{width:2px}.hdrw-list::-webkit-scrollbar-thumb{background:var(--border)}
  .hdrw-item{padding:10px 16px;border-bottom:1px solid #111;cursor:pointer;transition:background .12s}
  .hdrw-item:hover{background:rgba(255,255,255,.03)}
  .hdrw-item.selected{background:rgba(0,255,136,.04);border-left:2px solid var(--green)}
  .hdrw-sid{font-family:'Space Mono',monospace;font-size:9px;color:var(--green);letter-spacing:1px}
  .hdrw-meta{font-family:'Space Mono',monospace;font-size:8px;color:var(--text-dim);margin-top:3px}
  .hdrw-dec{display:inline-block;font-size:7px;padding:1px 5px;letter-spacing:1px;margin-top:3px}
  .hdrw-dec.APPROVE{background:rgba(0,255,136,.1);color:var(--green)}
  .hdrw-dec.DENY{background:rgba(255,34,68,.1);color:var(--red)}
  .hdrw-dec.REDIRECT{background:rgba(255,170,0,.1);color:var(--amber)}
  .hdrw-dec.RUNNING{background:rgba(255,255,255,.05);color:var(--text-dim)}
  .hdrw-cmd{font-size:9px;color:#666;margin-top:4px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:260px}
  .hdrw-foot{padding:10px 16px;border-top:1px solid var(--border);display:flex;gap:6px;flex-shrink:0}
  .hdrw-btn{flex:1;background:none;border:1px solid var(--border);color:var(--white);font-family:'Space Mono',monospace;font-size:8px;padding:6px;cursor:pointer;letter-spacing:1px}
  .hdrw-btn:hover{border-color:var(--green);color:var(--green)}
  .hdrw-btn.danger:hover{border-color:var(--red);color:var(--red)}
  /* Detail view */
  .hdrw-detail{flex:1;overflow-y:auto;display:none;padding:0}
  .hdrw-detail.open{display:flex;flex-direction:column}
  .hdrw-detail::-webkit-scrollbar{width:2px}.hdrw-detail::-webkit-scrollbar-thumb{background:var(--border)}
  .hdet-head{padding:12px 16px;border-bottom:1px solid var(--border);flex-shrink:0}
  .hdet-back{background:none;border:none;color:var(--amber);font-family:'Space Mono',monospace;font-size:9px;cursor:pointer;letter-spacing:1px;padding:0;margin-bottom:8px}
  .hdet-back:hover{color:var(--white)}
  .hdet-sid{font-family:'Bebas Neue',sans-serif;font-size:16px;letter-spacing:3px;color:var(--green)}
  .hdet-meta{font-family:'Space Mono',monospace;font-size:8px;color:var(--text-dim);line-height:1.8;margin-top:4px}
  .hdet-body{padding:12px 16px;display:flex;flex-direction:column;gap:10px}
  .hdet-section{background:var(--dim);border:1px solid var(--border);padding:10px}
  .hdet-label{font-size:7px;color:var(--text-dim);letter-spacing:2px;text-transform:uppercase;margin-bottom:6px;border-bottom:1px solid var(--border);padding-bottom:4px}
  .hdet-bounce{display:flex;align-items:center;justify-content:space-between;padding:4px 0;border-bottom:1px solid #111;font-size:9px}
  .hdet-bounce:last-child{border-bottom:none}
  .hdet-cmd{font-size:9px;color:#888;line-height:1.5;word-break:break-word;white-space:pre-wrap}
  .hdet-verdict{font-family:'Bebas Neue',sans-serif;font-size:20px;letter-spacing:3px;text-align:center;padding:8px 0}
  /* History toggle button */
  .hist-tog{background:none;border:1px solid var(--border);color:var(--white);font-family:'Space Mono',monospace;font-size:10px;padding:5px 10px;cursor:pointer;letter-spacing:1px;transition:all .15s}
  .hist-tog:hover{border-color:var(--green);color:var(--green)}
  .hist-tog .hcount{display:inline-block;background:var(--green);color:var(--black);font-size:8px;padding:0 4px;min-width:16px;text-align:center;margin-left:4px}
  /* Overlay */
  .hoverlay{position:fixed;inset:0;background:rgba(0,0,0,.5);z-index:199;display:none}
  .hoverlay.open{display:block}


  /* ── DIFF VIEW ─────────────────────────────────── */
  .diff-wrap{margin-top:8px;border-top:1px solid var(--border);padding-top:8px;display:none}
  .diff-wrap.open{display:block}
  .diff-title{font-family:'Space Mono',monospace;font-size:7px;color:var(--text-dim);letter-spacing:2px;text-transform:uppercase;margin-bottom:6px;display:flex;align-items:center;justify-content:space-between}
  .diff-toggle{background:none;border:1px solid var(--border);color:var(--text-dim);font-family:'Space Mono',monospace;font-size:7px;padding:2px 6px;cursor:pointer;letter-spacing:1px}
  .diff-toggle:hover{border-color:var(--amber);color:var(--amber)}
  .diff-summary{display:flex;gap:8px;margin-bottom:6px;flex-wrap:wrap}
  .diff-badge{font-size:7px;padding:2px 6px;letter-spacing:1px;font-family:'Space Mono',monospace}
  .diff-badge.add{background:rgba(0,255,136,.1);color:var(--green)}
  .diff-badge.rem{background:rgba(255,34,68,.1);color:var(--red)}
  .diff-badge.mod{background:rgba(255,170,0,.1);color:var(--amber)}
  .diff-badge.unch{background:rgba(255,255,255,.04);color:var(--text-dim)}
  .diff-lines{font-family:'Space Mono',monospace;font-size:9px;line-height:1.7;max-height:160px;overflow-y:auto;background:#050505;padding:8px;border:1px solid var(--border)}
  .diff-lines::-webkit-scrollbar{width:2px}.diff-lines::-webkit-scrollbar-thumb{background:var(--border)}
  .dl-add{color:var(--green)}.dl-rem{color:var(--red)}.dl-mod{color:var(--amber)}.dl-ctx{color:#444}
  .diff-semantic{margin-top:6px;display:flex;flex-direction:column;gap:3px}
  .diff-sem-row{font-size:8px;font-family:'Space Mono',monospace;padding:3px 6px;background:#0a0a0a;border-left:2px solid var(--border)}
  .diff-sem-row.add{border-left-color:var(--green);color:var(--green)}
  .diff-sem-row.rem{border-left-color:var(--red);color:var(--red)}
  .diff-sem-row.mod{border-left-color:var(--amber);color:var(--amber)}
  /* ── TYPE VALIDATION ────────────────────────────── */
  .tv-wrap{margin-top:6px;display:flex;flex-direction:column;gap:2px}
  .tv-row{display:flex;align-items:center;justify-content:space-between;font-size:8px;font-family:'Space Mono',monospace;padding:2px 0;border-bottom:1px solid #0f0f0f}
  .tv-row:last-child{border-bottom:none}
  .tv-field{color:var(--text-dim);flex:1}
  .tv-field.ok{color:var(--white)}
  .tv-rule{font-size:7px;color:var(--text-dim);flex:0 0 60px;text-align:center}
  .tv-st{font-size:7px;font-weight:bold;flex:0 0 24px;text-align:right}
  .tv-st.p{color:var(--green)}.tv-st.f{color:var(--red)}
  .tv-why{font-size:7px;color:var(--red);flex:0 0 auto;margin-left:6px;max-width:120px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}


  /* ── REPLAY MODAL ───────────────────────────── */
  .rpl-overlay{position:fixed;inset:0;background:rgba(0,0,0,.85);z-index:300;display:none;align-items:center;justify-content:center}
  .rpl-overlay.open{display:flex}
  .rpl-modal{background:#0c0c0c;border:1px solid var(--border);width:min(780px,95vw);max-height:90vh;display:flex;flex-direction:column;border-radius:2px}
  .rpl-head{padding:14px 20px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;flex-shrink:0}
  .rpl-title{font-family:'Bebas Neue',sans-serif;font-size:20px;letter-spacing:4px;color:var(--green)}
  .rpl-sub{font-family:'Space Mono',monospace;font-size:8px;color:var(--text-dim);letter-spacing:1px;margin-top:2px}
  .rpl-close{background:none;border:1px solid var(--border);color:var(--white);font-family:'Space Mono',monospace;font-size:10px;padding:4px 10px;cursor:pointer}
  .rpl-close:hover{border-color:var(--red);color:var(--red)}
  /* Timeline strip */
  .rpl-timeline{padding:16px 20px;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:0;overflow-x:auto;flex-shrink:0}
  .rpl-timeline::-webkit-scrollbar{height:2px}.rpl-timeline::-webkit-scrollbar-thumb{background:var(--border)}
  .rpl-node{display:flex;flex-direction:column;align-items:center;gap:4px;cursor:pointer;flex-shrink:0;min-width:52px;padding:0 4px}
  .rpl-node:hover .rpl-dot{border-color:var(--white)}
  .rpl-node.active .rpl-dot{background:var(--green);border-color:var(--green);box-shadow:0 0 8px rgba(0,255,136,.4)}
  .rpl-node.pass .rpl-dot{border-color:var(--green)}
  .rpl-node.fail .rpl-dot{border-color:var(--red)}
  .rpl-node.gate .rpl-dot{border-color:var(--amber)}
  .rpl-dot{width:14px;height:14px;border-radius:50%;background:#111;border:2px solid var(--border);transition:all .2s}
  .rpl-nlabel{font-family:'Space Mono',monospace;font-size:7px;color:var(--text-dim);text-align:center;letter-spacing:.5px}
  .rpl-nscore{font-family:'Space Mono',monospace;font-size:7px;color:var(--green)}
  .rpl-connector{flex:1;height:1px;background:var(--border);min-width:8px;align-self:flex-start;margin-top:8px}
  /* Step content */
  .rpl-body{flex:1;overflow-y:auto;padding:20px;display:flex;flex-direction:column;gap:12px;min-height:0}
  .rpl-body::-webkit-scrollbar{width:3px}.rpl-body::-webkit-scrollbar-thumb{background:var(--border)}
  .rpl-step-card{background:#111;border:1px solid var(--border);padding:14px;border-radius:2px;border-left:3px solid var(--border)}
  .rpl-step-card.pass{border-left-color:var(--green)}.rpl-step-card.fail{border-left-color:var(--red)}.rpl-step-card.gate{border-left-color:var(--amber)}
  .rpl-step-head{display:flex;align-items:center;justify-content:space-between;margin-bottom:8px}
  .rpl-step-model{font-family:'Space Mono',monospace;font-size:10px;color:var(--white)}
  .rpl-step-role{font-family:'Space Mono',monospace;font-size:7px;color:var(--text-dim);letter-spacing:1px;margin-top:2px}
  .rpl-step-score{font-family:'Bebas Neue',sans-serif;font-size:24px;color:var(--green);line-height:1}
  .rpl-step-output{font-family:'Space Mono',monospace;font-size:9px;color:#777;line-height:1.6;max-height:200px;overflow-y:auto;white-space:pre-wrap;word-break:break-word;background:#080808;padding:10px;border:1px solid #1a1a1a}
  .rpl-step-output::-webkit-scrollbar{width:2px}.rpl-step-output::-webkit-scrollbar-thumb{background:var(--border)}
  .rpl-meta-row{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:6px}
  .rpl-badge{font-size:7px;padding:2px 6px;letter-spacing:1px;font-family:'Space Mono',monospace}
  .rpl-badge.pass{background:rgba(0,255,136,.1);color:var(--green)}
  .rpl-badge.fail{background:rgba(255,34,68,.1);color:var(--red)}
  .rpl-badge.gate{background:rgba(255,170,0,.1);color:var(--amber)}
  .rpl-badge.dim{background:rgba(255,255,255,.04);color:var(--text-dim)}
  /* Nav */
  .rpl-nav{padding:12px 20px;border-top:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;flex-shrink:0}
  .rpl-navbtn{background:none;border:1px solid var(--border);color:var(--white);font-family:'Space Mono',monospace;font-size:10px;padding:6px 16px;cursor:pointer;letter-spacing:1px}
  .rpl-navbtn:hover{border-color:var(--green);color:var(--green)}
  .rpl-navbtn:disabled{opacity:.3;cursor:not-allowed}
  .rpl-progress{font-family:'Space Mono',monospace;font-size:9px;color:var(--text-dim)}
  .rpl-autoplay{background:none;border:1px solid var(--amber);color:var(--amber);font-family:'Space Mono',monospace;font-size:9px;padding:5px 12px;cursor:pointer;letter-spacing:1px}
  .rpl-autoplay:hover{background:rgba(255,170,0,.08)}
  .rpl-autoplay.playing{border-color:var(--red);color:var(--red)}

  /* ── GITHUB PUSH PANEL ──────────────────────── */
  .gh-panel{border-top:1px solid var(--border);padding:14px 20px;background:rgba(255,255,255,.01);display:none}
  .gh-panel.open{display:block}
  .gh-title{font-family:'Space Mono',monospace;font-size:9px;color:var(--amber);letter-spacing:2px;text-transform:uppercase;margin-bottom:10px;display:flex;align-items:center;justify-content:space-between}
  .gh-title button{background:none;border:none;color:var(--text-dim);font-size:11px;cursor:pointer;padding:0}
  .gh-title button:hover{color:var(--red)}
  .gh-grid{display:grid;grid-template-columns:1fr 1fr;gap:6px;margin-bottom:8px}
  .gh-field{display:flex;flex-direction:column;gap:3px}
  .gh-label{font-family:'Space Mono',monospace;font-size:7px;color:var(--text-dim);letter-spacing:1px;text-transform:uppercase}
  .gh-input{background:var(--dim);border:1px solid var(--border);color:var(--white);font-family:'Space Mono',monospace;font-size:9px;padding:5px 8px;outline:none;width:100%}
  .gh-input:focus{border-color:var(--green)}
  .gh-input::placeholder{color:var(--text-dim)}
  .gh-full{grid-column:1/-1}
  .gh-push-btn{width:100%;padding:10px;background:none;border:1px solid var(--green);color:var(--green);font-family:'Bebas Neue',sans-serif;font-size:16px;letter-spacing:3px;cursor:pointer;transition:all .15s}
  .gh-push-btn:hover{background:rgba(0,255,136,.08)}
  .gh-push-btn:disabled{opacity:.4;cursor:not-allowed}
  .gh-status{margin-top:6px;font-family:'Space Mono',monospace;font-size:9px;text-align:center;min-height:16px}
  .gh-status.ok{color:var(--green)}.gh-status.err{color:var(--red)}.gh-status.running{color:var(--amber)}
  .gh-note{font-size:7px;color:var(--text-dim);font-family:'Space Mono',monospace;margin-top:6px;line-height:1.5}

  /* ── SCHEMA BUILDER (nav item) ─────────────── */
  .sb-tog{font-family:'Space Mono',monospace;font-size:9px;padding:6px 10px;background:none;border:1px solid var(--border);color:var(--white);cursor:pointer;letter-spacing:1px}
  .sb-tog:hover{border-color:var(--green);color:var(--green)}

</style>
</head>
<body>

<header>
  <div class="logo">BOUNCE<span>.</span></div>
  <div class="hstatus">
    <div><span class="dot" id="cdot"></span><span id="clabel">CLAUDE —</span></div>
    <div><span class="dot" id="gdot"></span><span id="glabel">GROQ —</span></div>
    <div><span class="dot" id="odot"></span><span id="olabel">GPT —</span></div>
  </div>
  <nav class="sitenav">
    <a class="navbtn active" href="index.html">BOUNCE</a>
    <a class="navbtn" href="graph.html">GRAPH</a>
    <a class="navbtn" href="sandbox.html">SANDBOX</a>
    <a class="navbtn" href="schema.html">SCHEMAS</a>
    <button class="modetoggle" id="modetog" onclick="toggleMode()">◑</button>
  </nav>
</header>

<main>
  <div class="pleft">
    <div class="phead"><strong>L0 COMMAND</strong>Armand Lefebvre / Authority: FULL</div>

    <div class="aconf">
      <div class="arow">
        <span class="alabel" id="alabel">ANTHROPIC</span>
        <input class="akey" type="password" id="akey" placeholder="sk-ant-...">
      </div>
      <div class="arow">
        <span class="alabel" id="glabelk">GROQ</span>
        <input class="akey" type="password" id="gkey" placeholder="gsk_...">
      </div>
      <div class="arow">
        <span class="alabel" id="olabelk">OPENAI</span>
        <input class="akey" type="password" id="okey" placeholder="sk-proj-...">
      </div>
    </div>

    <div class="carea">
      <div class="clabel">Command</div>
      <textarea id="cmd" rows="5" placeholder="Enter L0 command...&#10;&#10;Example: Generate a valid LDS glazing assembly entity for a curtain wall unit with aluminum thermally broken frames and insulated glass."></textarea>

      <div class="clabel">Schema</div>
      <select class="ssel" id="schema">
        <option value="assembly">lds://schemas/construction/assembly/v1</option>
        <option value="material">lds://schemas/construction/material/v1</option>
        <option value="boundary">lds://schemas/validkernel/boundary/v1</option>
        <option value="generic">Generic — no schema enforcement</option>
      </select>

      <div class="sgrid">
        <div class="sblock">
          <div class="sblabel">Max Bounces</div>
          <div class="sbval" id="mbdisp">6</div>
          <div class="sctrl">
            <button class="bsm" onclick="adj('mb',-1)">−</button>
            <button class="bsm" onclick="adj('mb',1)">+</button>
          </div>
        </div>
        <div class="sblock">
          <div class="sblabel">Convergence %</div>
          <div class="sbval" id="ctdisp">95</div>
          <div class="sctrl">
            <button class="bsm" onclick="adj('ct',-5)">−</button>
            <button class="bsm" onclick="adj('ct',5)">+</button>
          </div>
        </div>
      </div>

      <button class="btnlaunch" id="lbtn" onclick="launch()">LAUNCH BOUNCE</button>
    </div>
  </div>

  <div class="pright">
    <div class="bhead">
      <div class="btitle"><strong>BOUNCE LOG</strong>L1 Kernel Gate — Real Time</div>
      <div class="cblock">
        <div class="cbwrap">
          <div class="cblabel">CONVERGENCE</div>
          <div class="cbar"><div class="cfill" id="cfill"></div></div>
        </div>
        <div class="cscore" id="cscore">—</div>
      </div>
    </div>

    <div class="blog" id="blog">
      <div class="empty" id="emp">
        <div class="ebig">IDLE</div>
        <div>Issue an L0 command to begin</div>
        <div style="color:var(--border);margin-top:4px">L0 → L1 → L2 → bounce → L0</div>
      </div>
    </div>

    
    <!-- GitHub Push Panel -->
    <div class="gh-panel" id="ghpanel">
      <div class="gh-title">
        <span>⬡ GITHUB PUSH</span>
        <button onclick="document.getElementById('ghpanel').classList.remove('open')">✕</button>
      </div>
      <div class="gh-grid">
        <div class="gh-field">
          <div class="gh-label">Owner / Org</div>
          <input class="gh-input" id="gh-owner" placeholder="jenkintownelectricity">
        </div>
        <div class="gh-field">
          <div class="gh-label">Repository</div>
          <input class="gh-input" id="gh-repo" placeholder="Bounce">
        </div>
        <div class="gh-field">
          <div class="gh-label">Branch</div>
          <input class="gh-input" id="gh-branch" placeholder="main">
        </div>
        <div class="gh-field">
          <div class="gh-label">File Path</div>
          <input class="gh-input" id="gh-path" placeholder="entities/BS-XXXXXXXX.lds.json">
        </div>
        <div class="gh-field gh-full">
          <div class="gh-label">Commit Message</div>
          <input class="gh-input" id="gh-msg" placeholder="ADD: entity via BOUNCE">
        </div>
        <div class="gh-field gh-full">
          <div class="gh-label">Personal Access Token (session only — never stored)</div>
          <input class="gh-input" id="gh-pat" type="password" placeholder="ghp_...">
        </div>
      </div>
      <button class="gh-push-btn" id="gh-push-btn" onclick="ghPush()">PUSH TO GITHUB</button>
      <div class="gh-status" id="gh-status"></div>
      <div class="gh-note">Token is held in memory only. Not written to localStorage. Cleared on page reload.</div>
    </div>

  <div class="apanel" id="apanel">
      <div class="atitle">⬡ AWAITING L0 APPROVAL</div>
      <div class="aout" id="aout"></div>
      <div class="abuts">
        <button class="bapprove" onclick="decide('APPROVE')">APPROVE</button>
        <button class="bredirect" onclick="decide('REDIRECT')">REDIRECT</button>
        <button class="bdeny" onclick="decide('DENY')">DENY</button>
        <button class="bdeny" style="color:var(--amber);border-color:var(--amber)" onclick="toggleGHPanel()">⬡ GITHUB</button>
      </div>
    </div>
  </div>
</main>

<footer>
  <span>VALIDKERNEL / LEFEBVRE DESIGN SOLUTIONS</span>
  <span id="sid">SESSION: —</span>
  <button class="hist-tog" onclick="openHistory()">HISTORY <span class="hcount" id="hcount">0</span></button>
  <span id="fstat">IDLE</span>
</footer>

<script>
const S={mb:6,ct:95,running:false,bounces:[],sid:null,final:null,lastScore:0};

const SCHEMAS={
  assembly:{
    name:'lds://schemas/construction/assembly/v1',
    req:['_lds.v','_lds.id','_lds.type','vectors.category','core.name','core.manufacturer','core.bom_structure','inference.relates_to','inference.requires'],
    sys:`You are an LDS entity generator. You follow instructions EXACTLY.

RULES:
- Output ONLY raw JSON. Start with {. End with }. No markdown. No prose. No explanation.
- When given specific field values in the instruction, USE THOSE EXACT VALUES.
- Never substitute placeholder values like "my-unit", "my-origin", "My Manufacturer".
- Never hallucinate generic content when specific content is provided.
- Required fields: _lds.v, _lds.id, _lds.type, _lds.created_at, _lds.origin, vectors.category (3+ tags), vectors.spatial.bounds (array format [[x,y,z],[x,y,z]]), vectors.temporal.install_phase (integer), core.name, core.manufacturer, core.bom_structure (array), inference.relates_to (array), inference.requires (array), inference.implies (array), media.spec_sheet.`
  },
  material:{
    name:'lds://schemas/construction/material/v1',
    req:['_lds.v','_lds.id','_lds.type','vectors.category','core.name','core.manufacturer'],
    sys:`You are an LDS material entity generator. Output ONLY raw JSON. No markdown. No prose. Start with { end with }.
Required: _lds.v, _lds.id (lds:construction/material/...), _lds.type, vectors.category (3+ tags), core.name, core.manufacturer, inference.relates_to, inference.requires.`
  },
  boundary:{
    name:'lds://schemas/validkernel/boundary/v1',
    req:['_lds.v','_lds.id','_lds.type','_lds.created_at','_lds.origin','core.domain','core.role','inference.allowed_actions','inference.conflicts','inference.requires'],
    sys:`You are a ValidKernel boundary entity generator. Output ONLY raw JSON. No markdown. Start with { end with }.

Required fields — use EXACTLY these types:
- _lds.v: STRING "0.1.0" (not a number)
- _lds.id: STRING starting with "lds:"
- _lds.type: STRING "agent_boundary"
- _lds.created_at: ISO datetime string e.g. "2026-02-18T00:00:00Z"
- _lds.origin: STRING org identifier
- core.domain: STRING
- core.role: STRING
- inference.allowed_actions: ARRAY of strings
- inference.conflicts: ARRAY of strings
- inference.requires: ARRAY of strings`
  },
  generic:{
    name:'Generic',
    req:[],
    sys:`You are a precise, helpful assistant. Answer the user's request clearly and completely.`
  }
};

function adj(k,d){
  if(k==='mb'){S.mb=Math.max(2,Math.min(12,S.mb+d));document.getElementById('mbdisp').textContent=S.mb}
  if(k==='ct'){S.ct=Math.max(60,Math.min(100,S.ct+d));document.getElementById('ctdisp').textContent=S.ct}
}

function getField(obj,path){return path.split('.').reduce((o,k)=>o&&o[k]!==undefined?o[k]:undefined,obj)}

function validate(txt,schema){
  if(!schema.req.length)return{score:100,passed:[],failed:[],obj:null};
  let obj;
  try{obj=JSON.parse(txt)}catch(e){return{score:0,passed:[],failed:schema.req,obj:null,err:e.message}}
  const passed=[],failed=[];
  for(const f of schema.req){
    const v=getField(obj,f);
    (v!==undefined&&v!==null&&v!==''&&!(Array.isArray(v)&&!v.length)?passed:failed).push(f);
  }
  return{score:Math.round(passed.length/schema.req.length*100),passed,failed,obj};
}

function extractJSON(t){
  try{JSON.parse(t);return t}catch(e){}
  const b=t.match(/```(?:json)?\s*([\s\S]*?)```/);
  if(b)try{JSON.parse(b[1]);return b[1]}catch(e){}
  const s=t.indexOf('{'),e=t.lastIndexOf('}');
  if(s>-1&&e>-1){const c=t.slice(s,e+1);try{JSON.parse(c);return c}catch(e){}}
  return t;
}

async function callGroq(prompt,sys,key){
  const r=await fetch('https://api.groq.com/openai/v1/chat/completions',{
    method:'POST',
    headers:{'Authorization':'Bearer '+key,'Content-Type':'application/json'},
    body:JSON.stringify({model:'llama-3.3-70b-versatile',messages:[{role:'system',content:sys},{role:'user',content:prompt}],temperature:0.05,max_tokens:2500})
  });
  if(!r.ok)throw new Error('Groq '+r.status+': '+await r.text());
  return(await r.json()).choices[0].message.content;
}

async function callClaude(prompt,sys,key){
  const r=await fetch('https://api.anthropic.com/v1/messages',{
    method:'POST',
    headers:{
      'x-api-key':key,
      'anthropic-version':'2023-06-01',
      'content-type':'application/json',
      'anthropic-dangerous-direct-browser-access':'true'
    },
    body:JSON.stringify({
      model:'claude-haiku-4-5-20251001',
      max_tokens:2500,
      system:sys,
      messages:[{role:'user',content:prompt}]
    })
  });
  if(!r.ok)throw new Error('Claude '+r.status+': '+await r.text());
  return(await r.json()).content[0].text;
}

async function callGPT(prompt,sys,key){
  const r=await fetch('https://api.openai.com/v1/chat/completions',{
    method:'POST',
    headers:{'Authorization':'Bearer '+key,'Content-Type':'application/json'},
    body:JSON.stringify({
      model:'gpt-4o-mini',
      messages:[{role:'system',content:sys},{role:'user',content:prompt}],
      temperature:0.1,
      max_tokens:1500
    })
  });
  if(!r.ok)throw new Error('GPT '+r.status+': '+await r.text());
  return(await r.json()).choices[0].message.content;
}

function esc(s){return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;')}

function addCard(num,model,role,status,content,score){
  const log=document.getElementById('blog');
  const emp=document.getElementById('emp');
  if(emp)emp.remove();
  const c=document.createElement('div');
  c.className='bcard '+status.toLowerCase();
  c.id='c'+num+model.replace(/\s/g,'');
  const sid='cb'+num+model.replace(/\s/g,'');
  c.innerHTML=`<div class="ch" onclick="tog('${sid}')">
    <div class="cmeta">
      <span class="cnum">${num>0?'B'+num:'⬡'}</span>
      <div><div class="cmod">${model}</div><div class="crole">${role}</div></div>
    </div>
    <div style="display:flex;gap:10px;align-items:center">
      ${score!==null?`<span class="cscr">${score}%</span>`:''}
      <span class="cst ${status}">${status}</span>
    </div>
  </div>
  <div class="cbody" id="${sid}"><pre>${esc(content)}</pre></div>`;
  log.appendChild(c);
  log.scrollTop=log.scrollHeight;
  return c;
}

function tog(id){const e=document.getElementById(id);if(e)e.classList.toggle('open')}

function setConv(score){
  S.lastScore=score;
  document.getElementById('cscore').textContent=score+'%';
  const f=document.getElementById('cfill');
  f.style.width=score+'%';
  f.style.background=score>=95?'var(--green)':score>=70?'var(--amber)':'var(--red)';
}

function setFoot(t){document.getElementById('fstat').textContent=t}

async function launch(){
  const cmd=document.getElementById('cmd').value.trim();
  const ak=document.getElementById('akey').value.trim();
  const gk=document.getElementById('gkey').value.trim();
  const sk=document.getElementById('schema').value;
  const schema=SCHEMAS[sk];

  if(!cmd){alert('Enter an L0 command.');return}
  if(!ak){alert('Anthropic API key required.');return}
  if(!gk){alert('Groq API key required.');return}

  S.running=true;S.bounces=[];S.final=null;
  S.sid='BS-'+Date.now().toString(36).toUpperCase();

  document.getElementById('blog').innerHTML='';
  document.getElementById('apanel').classList.remove('vis');
  document.getElementById('lbtn').disabled=true;
  document.getElementById('lbtn').textContent='BOUNCING...';
  document.getElementById('sid').textContent='SESSION: '+S.sid;
  hlRecordStart();
  setConv(0);setFoot('RUNNING');

  document.getElementById('cdot').className='dot live';
  document.getElementById('gdot').className='dot live';
  document.getElementById('clabel').textContent='BUILDER — ACTIVE';
  document.getElementById('glabel').textContent='EXECUTOR — ACTIVE';

  addCard(0,'L1 KERNEL','GATE CHECK','GATE',
    `Command received.\nSchema: ${schema.name}\nRequired fields: ${schema.req.length}\nMax bounces: ${S.mb}\nThreshold: ${S.ct}%\n\n→ ROUTING TO L2 EXECUTOR`,null);

  let lastOut='',consecutive=0,bn=0;

  try{
    while(bn<S.mb){
      bn++;
      const useGroq=(bn%2===1);
      const mname=useGroq?'GROQ / Llama-3.3-70B':'CLAUDE / Haiku';
      const role=useGroq?'EXECUTOR':'BUILDER';

      let prompt;
      if(bn===1){
        prompt=`INSTRUCTION: ${cmd}\n\nYOU MUST FOLLOW THE INSTRUCTION ABOVE EXACTLY.\nDO NOT echo back the input entity unchanged.\nDO NOT ignore the requested changes.\nOutput ONLY raw JSON. Start with {. End with }. Nothing else.`;
      } else {
        const last=S.bounces[S.bounces.length-1];
        prompt=`INSTRUCTION: ${cmd}\n\nYOUR PREVIOUS OUTPUT HAD THESE SCHEMA FAILURES:\n${last?.failed?.join('\n')||'none'}\n\nPREVIOUS OUTPUT FOR REFERENCE:\n${lastOut}\n\nFIX ALL FAILURES. APPLY ALL CHANGES FROM THE INSTRUCTION.\nOutput ONLY raw JSON. Start with {. End with }. Nothing else.`;
      }

      const runCard=addCard(bn,mname,role,'RUNNING',`Executing...`,null);
      setFoot(`BOUNCE ${bn}/${S.mb} — ${mname}`);

      let output;
      try{
        output=useGroq?await callGroq(prompt,schema.sys,gk):await callClaude(prompt,schema.sys,ak);
      }catch(err){
        runCard.className='bcard fail';
        runCard.querySelector('.cst').textContent='FAIL';
        runCard.querySelector('.cst').className='cst FAIL';
        runCard.querySelector('pre').textContent='API ERROR: '+err.message;
        if(useGroq){document.getElementById('gdot').className='dot err';document.getElementById('glabel').textContent='EXECUTOR — ERROR';}
        else{document.getElementById('cdot').className='dot err';document.getElementById('clabel').textContent='BUILDER — ERROR';}
        break;
      }

      const clean=schema.req.length>0?extractJSON(output):output;
      const v=validate(clean,schema);

      // Update card
      const passed=v.score>=S.ct;
      runCard.className='bcard '+(passed?'pass':'fail');
      const st=runCard.querySelector('.cst');
      st.textContent=passed?'PASS':'FAIL';
      st.className='cst '+(passed?'PASS':'FAIL');

      const meta=runCard.querySelector('.ch > div:last-child');
      const scEl=document.createElement('span');
      scEl.className='cscr';scEl.textContent=v.score+'%';
      meta.insertBefore(scEl,meta.firstChild);

      let bodyText=clean.length>900?clean.slice(0,900)+'\n\n[truncated — click header to expand]':clean;
      if(v.failed.length)bodyText+='\n\nMISSING: '+v.failed.join(', ');
      if(v.passed.length&&schema.req.length)bodyText+='\nPRESENT: '+v.passed.join(', ');
      runCard.querySelector('pre').textContent=bodyText;

      setConv(v.score);
      S.bounces.push({bn,model:mname,role,output:clean,score:v.score,failed:v.failed});
      // Diff + type validation
      if(bn>1&&S.bounces.length>=2){
        const prev=S.bounces[S.bounces.length-2];
        renderDiff(runCard,prev.output,clean,bn);
      }
      renderTypeValidation(runCard,clean,sk);
      lastOut=clean;

      if(passed){
        consecutive++;
        addCard(0,'L1 KERNEL','GATE CHECK','GATE',
          `✓ Bounce ${bn} PASSED — ${v.score}%\nConsecutive: ${consecutive}/2\n${consecutive>=2?'→ CONVERGENCE ACHIEVED':'→ Confirming...'}`,null);
        if(consecutive>=2){
          S.final=clean;
          addCard(0,'CONVERGED','SESSION COMPLETE','GATE',
            `Session: ${S.sid}\nBounces: ${bn}\nScore: ${v.score}%\n\n→ RUNNING GPT FACT-CHECK`,null);

          // GPT FACT-CHECKER PASS
          const ok=document.getElementById('okey').value.trim();
          if(ok){
            const gptCard=addCard(0,'GPT / gpt-4o-mini','FACT-CHECKER','RUNNING','Checking logical consistency...',null);
            try{
              const gptPrompt=`You are a strict technical fact-checker for LDS (Logic Data System) entities.

Review this entity and check for:
1. Semantic consistency — do the type, category tags, BOM, and name all agree?
2. Logical completeness — are inference.relates_to references plausible?
3. Data integrity — are quantities, units, and spatial bounds reasonable?
4. Schema compliance — are all required fields present and non-empty?

Entity to review:
${clean}

Respond in this exact format:
VERDICT: PASS or FAIL
ISSUES: (list any problems found, or "none")
CONFIDENCE: (0-100%)`;

              const gptSys=`You are a precise technical auditor. You review structured data for logical consistency and flag issues concisely. Never add fields or suggest improvements unless explicitly asked. Only audit what is there.`;
              const gptResult=await callGPT(gptPrompt,gptSys,ok);

              const gptPass=gptResult.includes('VERDICT: PASS');
              gptCard.className='bcard '+(gptPass?'pass':'fail');
              gptCard.querySelector('.cst').textContent=gptPass?'PASS':'FAIL';
              gptCard.querySelector('.cst').className='cst '+(gptPass?'PASS':'FAIL');
              gptCard.querySelector('pre').textContent=gptResult;

              if(!gptPass){
                addCard(0,'L1 KERNEL','FACT-CHECK GATE','GATE',
                  `GPT flagged issues.\n${gptResult}\n\n→ ESCALATING TO L0 FOR REVIEW ANYWAY`,null);
              } else {
                addCard(0,'L1 KERNEL','FACT-CHECK GATE','GATE',
                  `✓ GPT fact-check PASSED\n→ AWAITING L0 APPROVAL`,null);
              }
            }catch(err){
              gptCard.className='bcard gate';
              gptCard.querySelector('.cst').textContent='SKIP';
              gptCard.querySelector('.cst').className='cst GATE';
              gptCard.querySelector('pre').textContent='GPT unavailable: '+err.message+'\n→ Skipping fact-check, escalating to L0';
            }
          } else {
            addCard(0,'GPT','FACT-CHECKER','GATE','No OpenAI key — skipping fact-check\n→ AWAITING L0 APPROVAL',null);
          }

          addCard(0,'CONVERGED','AWAITING L0','GATE',
            `Session: ${S.sid}\nBounces: ${bn}\nKernel score: ${v.score}%\n\n→ AWAITING L0 APPROVAL`,null);
          break;
        }
      } else {
        consecutive=0;
        addCard(0,'L1 KERNEL','GATE CHECK','GATE',
          `✗ Bounce ${bn} FAILED — ${v.score}%\nMissing: ${v.failed.join(', ')}\nReset consecutive to 0\n→ ROUTING BACK TO L2`,null);
      }

      await new Promise(r=>setTimeout(r,350));
    }

    if(!S.final&&S.bounces.length){
      const best=S.bounces.reduce((a,b)=>b.score>a.score?b:a);
      S.final=best.output;
      addCard(0,'L1 KERNEL','MAX BOUNCES','GATE',
        `Max bounces (${S.mb}) reached.\nBest: ${best.score}% at bounce ${best.bn}\nEscalating to L0.`,null);
    }
  }catch(err){
    addCard(0,'SYSTEM','ERROR','FAIL','Fatal: '+err.message,null);
  }

  if(S.final){
    document.getElementById('apanel').classList.add('vis');
    document.getElementById('aout').textContent=S.final.length>1200?S.final.slice(0,1200)+'\n...[see log for full output]':S.final;
  }

  S.running=false;
  document.getElementById('lbtn').disabled=false;
  document.getElementById('lbtn').textContent='LAUNCH BOUNCE';
  setFoot(`COMPLETE — ${S.bounces.length} bounces — ${S.lastScore}%`);
  // Update history with final bounce data
  if(S.sid){const _r=hlLoad().find(x=>x.session_id===S.sid);if(_r){_r.bounces=S.bounces.map(b=>({bn:b.bn,model:b.model,role:b.role,score:b.score,failed:b.failed||[],passed:b.passed||[],output_preview:(b.output||'').slice(0,200)}));_r.total_bounces=S.bounces.length;_r.final_score=S.lastScore;_r.final_output_preview=S.final?S.final.slice(0,500):null;const _all=hlLoad();const _i=_all.findIndex(x=>x.session_id===S.sid);if(_i>=0){_all[_i]=_r;hlSave(_all);}}}
}

function decide(d){
  document.getElementById('apanel').classList.remove('vis');
  const c=addCard(0,'L0 / ARMAND LEFEBVRE','DECISION','GATE',
    `DECISION: ${d}\nSession: ${S.sid}\nTimestamp: ${new Date().toISOString()}\n\n${
      d==='APPROVE'?'✓ Approved. Downloading entity file.':
      d==='DENY'?'✗ Denied. Issue new command.':
      '⟳ Redirect. Modify command and relaunch.'
    }`,null);

  const col=d==='APPROVE'?'var(--green)':d==='DENY'?'var(--red)':'var(--amber)';
  c.style.borderLeftColor=col;

  setFoot('L0 '+d+' — '+S.sid);
  hlRecord(d);

  if(d==='APPROVE'&&S.final){
    const blob=new Blob([S.final],{type:'application/json'});
    const url=URL.createObjectURL(blob);
    const a=document.createElement('a');
    a.href=url;a.download=S.sid+'.lds.json';a.click();
    URL.revokeObjectURL(url);
  }
  if(d==='REDIRECT')document.getElementById('cmd').focus();
}

// Init — pre-fill keys
window.addEventListener('load',()=>{
  document.getElementById('cdot').className='dot';
  document.getElementById('gdot').className='dot';
  document.getElementById('odot').className='dot';
  document.getElementById('clabel').textContent='CLAUDE — KEY REQUIRED';
  document.getElementById('glabel').textContent='GROQ — KEY REQUIRED';
  document.getElementById('olabel').textContent='GPT — KEY REQUIRED';

  // Wire up key fields to show live status
  document.getElementById('akey').addEventListener('input',e=>{
    const ok=e.target.value.trim().length>10;
    document.getElementById('cdot').className='dot'+(ok?' live':'');
    document.getElementById('clabel').textContent='CLAUDE — '+(ok?'READY':'KEY REQUIRED');
    document.getElementById('alabel').className='alabel'+(ok?' ok':'');
  });
  document.getElementById('gkey').addEventListener('input',e=>{
    const ok=e.target.value.trim().length>10;
    document.getElementById('gdot').className='dot'+(ok?' live':'');
    document.getElementById('glabel').textContent='GROQ — '+(ok?'READY':'KEY REQUIRED');
    document.getElementById('glabelk').className='alabel'+(ok?' ok':'');
  });
  document.getElementById('okey').addEventListener('input',e=>{
    const ok=e.target.value.trim().length>10;
    document.getElementById('odot').className='dot'+(ok?' live':'');
    document.getElementById('olabel').textContent='GPT — '+(ok?'READY':'OPTIONAL');
    document.getElementById('olabelk').className='alabel'+(ok?' ok':'');
  });

  setFoot('IDLE — ENTER API KEYS TO BEGIN');
});


// ── SESSION HISTORY / AUDIT LOG ──────────────────────────────────────────────
const HL_KEY = 'vk-history-v1';

function hlLoad() {
  try { return JSON.parse(localStorage.getItem(HL_KEY) || '[]'); }
  catch(e) { return []; }
}

function hlSave(records) {
  try { localStorage.setItem(HL_KEY, JSON.stringify(records)); } catch(e) {}
  updateHistoryCount();
}

function updateHistoryCount() {
  const n = hlLoad().length;
  document.getElementById('hcount').textContent = n;
}

function hlRecord(decision) {
  if (!S.sid) return;
  const records = hlLoad();
  const existing = records.findIndex(r => r.session_id === S.sid);
  const schema_el = document.getElementById('schema');
  const record = {
    session_id: S.sid,
    created_at: new Date().toISOString(),
    schema_name: schema_el ? schema_el.value : 'unknown',
    max_bounces: S.mb,
    threshold: S.ct,
    models_used: { groq: 'llama-3.3-70b-versatile', claude: 'claude-haiku-4-5-20251001', gpt: 'gpt-4o-mini' },
    command: (document.getElementById('cmd') || {}).value || '',
    bounces: S.bounces.map(b => ({
      bn: b.bn, model: b.model, role: b.role,
      score: b.score, failed: b.failed || [], passed: b.passed || [],
      output_preview: (b.output || '').slice(0, 200)
    })),
    final_score: S.lastScore,
    total_bounces: S.bounces.length,
    decision: decision,
    download_filename: decision === 'APPROVE' ? S.sid + '.lds.json' : null,
    final_output_preview: S.final ? S.final.slice(0, 500) : null
  };
  if (existing >= 0) { records[existing] = record; }
  else { records.unshift(record); }
  if (records.length > 200) records.splice(200);
  hlSave(records);
}

// Auto-save as RUNNING when session starts
function hlRecordStart() {
  if (!S.sid) return;
  const records = hlLoad();
  const schema_el = document.getElementById('schema');
  records.unshift({
    session_id: S.sid,
    created_at: new Date().toISOString(),
    schema_name: schema_el ? schema_el.value : 'unknown',
    max_bounces: S.mb,
    threshold: S.ct,
    models_used: { groq: 'llama-3.3-70b-versatile', claude: 'claude-haiku-4-5-20251001', gpt: 'gpt-4o-mini' },
    command: (document.getElementById('cmd') || {}).value || '',
    bounces: [], final_score: 0, total_bounces: 0,
    decision: 'RUNNING', download_filename: null, final_output_preview: null
  });
  if (records.length > 200) records.splice(200);
  hlSave(records);
}

function openHistory() {
  renderHistoryList();
  document.getElementById('hdrw').classList.add('open');
  document.getElementById('hoverlay').classList.add('open');
  document.getElementById('hdrw-detail').classList.remove('open');
  document.getElementById('hdrw-list').style.display = 'block';
}

function closeHistory() {
  document.getElementById('hdrw').classList.remove('open');
  document.getElementById('hoverlay').classList.remove('open');
}

function renderHistoryList() {
  const q = (document.getElementById('hsearch').value || '').toLowerCase();
  const records = hlLoad().filter(r =>
    !q || r.session_id.toLowerCase().includes(q) ||
    (r.command || '').toLowerCase().includes(q) ||
    (r.schema_name || '').includes(q) ||
    (r.decision || '').toLowerCase().includes(q)
  );
  const list = document.getElementById('hdrw-list');
  updateHistoryCount();
  if (!records.length) {
    list.innerHTML = '<div style="padding:20px;text-align:center;color:var(--text-dim);font-size:9px;font-family:Space Mono,monospace">' + (q ? 'NO MATCHES' : 'NO SESSIONS YET') + '</div>';
    return;
  }
  list.innerHTML = records.map(r => {
    const dt = new Date(r.created_at);
    const timeStr = dt.toLocaleDateString() + ' ' + dt.toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'});
    const cmdPreview = (r.command || '').slice(0, 60) + ((r.command||'').length > 60 ? '…' : '');
    return `<div class="hdrw-item" onclick="showHistoryDetail('${r.session_id}')">
      <div class="hdrw-sid">${r.session_id}</div>
      <div class="hdrw-meta">${timeStr} · ${r.schema_name} · ${r.total_bounces}B · ${r.final_score}%</div>
      <div><span class="hdrw-dec ${r.decision}">${r.decision}</span></div>
      <div class="hdrw-cmd">${cmdPreview || '—'}</div>
    </div>`;
  }).join('');
}

function showHistoryDetail(sid) {
  const records = hlLoad();
  const r = records.find(x => x.session_id === sid);
  if (!r) return;
  const list = document.getElementById('hdrw-list');
  const detail = document.getElementById('hdrw-detail');
  list.style.display = 'none';
  detail.classList.add('open');
  const dt = new Date(r.created_at);
  const decColor = r.decision === 'APPROVE' ? 'var(--green)' : r.decision === 'DENY' ? 'var(--red)' : r.decision === 'RUNNING' ? 'var(--text-dim)' : 'var(--amber)';
  detail.innerHTML = `
    <div class="hdet-head">
      <button class="hdet-back" onclick="backToList()">← BACK</button>
      <div class="hdet-sid">${r.session_id}</div>
      <div class="hdet-meta">
        ${dt.toLocaleDateString()} ${dt.toLocaleTimeString()}<br>
        Schema: ${r.schema_name} · Max bounces: ${r.max_bounces} · Threshold: ${r.threshold}%<br>
        Bounces used: ${r.total_bounces} · Final score: ${r.final_score}%
      </div>
    </div>
    <div class="hdet-body">
      <div class="hdet-section">
        <div class="hdet-label">Decision</div>
        <div class="hdet-verdict" style="color:${decColor}">${r.decision}</div>
        ${r.download_filename ? `<div style="font-size:8px;color:var(--text-mid);text-align:center">${r.download_filename}</div>` : ''}
      </div>
      <div class="hdet-section">
        <div class="hdet-label">L0 Command</div>
        <div class="hdet-cmd">${r.command || '—'}</div>
        <button onclick="reloadCommand('${sid}')" style="margin-top:8px;background:none;border:1px solid var(--border);color:var(--amber);font-family:Space Mono,monospace;font-size:8px;padding:4px 8px;cursor:pointer;letter-spacing:1px;width:100%">↩ RELOAD COMMAND</button>
      </div>
      <div class="hdet-section">
        <div class="hdet-label">Bounce Timeline (${r.bounces.length})</div>
        ${r.bounces.length ? r.bounces.map(b => `
          <div class="hdet-bounce">
            <span style="color:var(--text-dim);font-family:Space Mono,monospace">B${b.bn}</span>
            <span style="color:var(--white);font-size:8px">${b.model}</span>
            <span style="font-family:Space Mono,monospace;font-size:8px;color:var(--text-dim)">${b.role}</span>
            <span style="color:${b.score>=r.threshold?'var(--green)':'var(--red)'};font-family:Space Mono,monospace">${b.score}%</span>
          </div>`).join('') : '<div style="color:var(--text-dim);font-size:9px">No bounces recorded</div>'}
      </div>
      ${r.final_output_preview ? `
      <div class="hdet-section">
        <div class="hdet-label">Final Output Preview</div>
        <pre style="font-family:Space Mono,monospace;font-size:9px;color:#777;white-space:pre-wrap;word-break:break-word;max-height:120px;overflow-y:auto">${r.final_output_preview}${r.final_output_preview.length >= 500 ? '\n...' : ''}</pre>
        ${r.decision === 'APPROVE' ? `<button onclick="redownload('${sid}')" style="margin-top:8px;background:none;border:1px solid var(--green);color:var(--green);font-family:Space Mono,monospace;font-size:8px;padding:4px 8px;cursor:pointer;letter-spacing:1px;width:100%">↓ RE-DOWNLOAD</button>` : ''}
      </div>` : ''}
    </div>`;
}

function backToList() {
  document.getElementById('hdrw-detail').classList.remove('open');
  document.getElementById('hdrw-list').style.display = 'block';
  renderHistoryList();
}

function reloadCommand(sid) {
  const r = hlLoad().find(x => x.session_id === sid);
  if (!r || !r.command) return;
  document.getElementById('cmd').value = r.command;
  if (r.schema_name) document.getElementById('schema').value = r.schema_name;
  closeHistory();
  document.getElementById('cmd').focus();
}

function redownload(sid) {
  const records = hlLoad();
  const r = records.find(x => x.session_id === sid);
  if (!r || !r.final_output_preview) return;
  // Try to get full output from current session if matching
  const json = S.sid === sid && S.final ? S.final : r.final_output_preview;
  const blob = new Blob([json], {type:'application/json'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = (r.download_filename || sid + '.lds.json');
  a.click(); URL.revokeObjectURL(url);
}

function exportHistory() {
  const records = hlLoad();
  const blob = new Blob([JSON.stringify(records, null, 2)], {type:'application/json'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = 'vk-audit-log-' + Date.now().toString(36).toUpperCase() + '.json';
  a.click(); URL.revokeObjectURL(url);
}

function importHistoryPrompt() { document.getElementById('himport').click(); }

function importHistory(event) {
  const file = event.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = e => {
    try {
      const imported = JSON.parse(e.target.result);
      if (!Array.isArray(imported)) { alert('Invalid history file — expected JSON array.'); return; }
      const existing = hlLoad();
      const existingIds = new Set(existing.map(r => r.session_id));
      const merged = [...existing, ...imported.filter(r => !existingIds.has(r.session_id))];
      merged.sort((a,b) => new Date(b.created_at) - new Date(a.created_at));
      hlSave(merged);
      renderHistoryList();
      alert('Imported ' + imported.length + ' sessions (' + (merged.length - existing.length) + ' new).');
    } catch(ex) { alert('Import failed: ' + ex.message); }
  };
  reader.readAsText(file);
  event.target.value = '';
}

function clearHistory() {
  if (!confirm('Clear all ' + hlLoad().length + ' session records? This cannot be undone.')) return;
  localStorage.removeItem(HL_KEY);
  updateHistoryCount();
  renderHistoryList();
}

// Init count on load
window.addEventListener('load', () => { updateHistoryCount(); }, {once: false});


// ── DIFF ENGINE ──────────────────────────────────────────────────────────────
function flattenObj(obj, prefix='') {
  const out = {};
  for (const [k, v] of Object.entries(obj || {})) {
    const path = prefix ? prefix + '.' + k : k;
    if (v !== null && typeof v === 'object' && !Array.isArray(v)) {
      Object.assign(out, flattenObj(v, path));
    } else {
      out[path] = JSON.stringify(v);
    }
  }
  return out;
}

function computeDiff(prevTxt, nextTxt) {
  let prevObj, nextObj;
  try { prevObj = JSON.parse(prevTxt); } catch(e) { prevObj = {}; }
  try { nextObj = JSON.parse(nextTxt); } catch(e) { nextObj = {}; }

  const prev = flattenObj(prevObj);
  const next = flattenObj(nextObj);
  const allKeys = new Set([...Object.keys(prev), ...Object.keys(next)]);

  const added = [], removed = [], modified = [], unchanged = [];

  for (const k of allKeys) {
    if (!(k in prev) && k in next) added.push({ path: k, val: next[k] });
    else if (k in prev && !(k in next)) removed.push({ path: k, val: prev[k] });
    else if (prev[k] !== next[k]) modified.push({ path: k, from: prev[k], to: next[k] });
    else unchanged.push(k);
  }

  // Semantic summary (rule-based, no model call)
  const semantic = [];
  for (const a of added) semantic.push({ type:'add', msg: `+ ${a.path}: ${a.val}` });
  for (const r of removed) semantic.push({ type:'rem', msg: `− ${r.path} removed (was ${r.val})` });
  for (const m of modified) {
    // Detect type coercion
    let note = '';
    try {
      const fromParsed = JSON.parse(m.from);
      const toParsed = JSON.parse(m.to);
      if (typeof fromParsed !== typeof toParsed) {
        note = ` [${typeof fromParsed}→${typeof toParsed}]`;
      }
    } catch(e) {}
    semantic.push({ type:'mod', msg: `~ ${m.path}: ${m.from} → ${m.to}${note}` });
  }

  return { added, removed, modified, unchanged, semantic };
}

function renderDiff(card, prevTxt, nextTxt, bn) {
  if (!prevTxt) return; // no previous to diff against
  const diff = computeDiff(prevTxt, nextTxt);
  const total = diff.added.length + diff.removed.length + diff.modified.length;
  if (total === 0 && diff.unchanged.length > 0) return; // identical

  const body = card.querySelector('.cbody');
  if (!body) return;

  // Build diff HTML
  let html = `<div class="diff-wrap open">
    <div class="diff-title">
      <span>DIFF vs B${bn-1}</span>
      <button class="diff-toggle" onclick="this.closest('.diff-wrap').querySelector('.diff-lines').style.display=this.closest('.diff-wrap').querySelector('.diff-lines').style.display==='none'?'block':'none';this.textContent=this.textContent==='▼ LINES'?'▲ LINES':'▼ LINES'">▼ LINES</button>
    </div>
    <div class="diff-summary">
      ${diff.added.length?`<span class="diff-badge add">+${diff.added.length} ADDED</span>`:''}
      ${diff.removed.length?`<span class="diff-badge rem">−${diff.removed.length} REMOVED</span>`:''}
      ${diff.modified.length?`<span class="diff-badge mod">~${diff.modified.length} CHANGED</span>`:''}
      ${diff.unchanged.length?`<span class="diff-badge unch">${diff.unchanged.length} SAME</span>`:''}
    </div>
    <div class="diff-lines">
      ${diff.added.slice(0,30).map(a=>`<div class="dl-add">+ ${esc(a.path)}: ${esc(a.val)}</div>`).join('')}
      ${diff.removed.slice(0,30).map(r=>`<div class="dl-rem">− ${esc(r.path)}: ${esc(r.val)}</div>`).join('')}
      ${diff.modified.slice(0,30).map(m=>`<div class="dl-mod">~ ${esc(m.path)}<br>  ${esc(m.from)} → ${esc(m.to)}</div>`).join('')}
      ${(diff.added.length+diff.removed.length+diff.modified.length>30)?'<div class="dl-ctx">... truncated</div>':''}
    </div>
    <div class="diff-semantic">
      ${diff.semantic.slice(0,12).map(s=>`<div class="diff-sem-row ${s.type}">${esc(s.msg)}</div>`).join('')}
    </div>
  </div>`;
  body.insertAdjacentHTML('beforeend', html);
}

// ── TYPE-AWARE VALIDATION ─────────────────────────────────────────────────────
const TYPE_RULES = {
  assembly: [
    { path:'_lds.v',           rule:'type',   expected:'string' },
    { path:'_lds.id',          rule:'type',   expected:'string' },
    { path:'_lds.type',        rule:'enum',   values:['mechanical_assembly','structural_assembly','electrical_assembly','composite_assembly','agent_boundary'] },
    { path:'_lds.created_at',  rule:'pattern',pattern:/^\d{4}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2}/ },
    { path:'vectors.spatial.bounds', rule:'shape', validator: v => {
      if(!Array.isArray(v)||v.length!==2)return'must be [[x,y,z],[x,y,z]]';
      for(const pt of v){ if(!Array.isArray(pt)||pt.length!==3)return'each point must be [x,y,z]'; if(pt.some(n=>typeof n!=='number'))return'coords must be numbers'; }
      return null;
    }},
    { path:'vectors.temporal.install_phase', rule:'type', expected:'number' },
    { path:'core.bom_structure', rule:'type', expected:'array' },
    { path:'inference.relates_to', rule:'type', expected:'array' },
    { path:'inference.requires',   rule:'type', expected:'array' },
  ],
  material: [
    { path:'_lds.v',   rule:'type', expected:'string' },
    { path:'_lds.id',  rule:'type', expected:'string' },
    { path:'_lds.type',rule:'type', expected:'string' },
    { path:'inference.relates_to', rule:'type', expected:'array' },
    { path:'inference.requires',   rule:'type', expected:'array' },
  ],
  boundary: [
    { path:'_lds.v',    rule:'type', expected:'string' },
    { path:'_lds.id',   rule:'type', expected:'string' },
    { path:'_lds.type', rule:'enum', values:['agent_boundary','service_boundary','data_boundary'] },
    { path:'core.domain', rule:'type', expected:'string' },
    { path:'core.role',   rule:'enum', values:['l0-authority','l1-kernel','l2-proposer'] },
    { path:'inference.allowed_actions', rule:'type', expected:'array' },
    { path:'inference.conflicts',       rule:'type', expected:'array' },
    { path:'inference.requires',        rule:'type', expected:'array' },
  ],
  generic: []
};

function validateTypes(txt, schemaKey) {
  const rules = TYPE_RULES[schemaKey] || [];
  if (!rules.length) return { results:[], score:100, typeScore:100 };
  let obj;
  try { obj = JSON.parse(txt); } catch(e) { return { results:[], score:0, typeScore:0, err:e.message }; }

  const results = rules.map(rule => {
    const val = getField(obj, rule.path);
    if (val === undefined || val === null) return { path:rule.path, rule:rule.rule, pass:false, why:'missing' };
    let why = null;
    if (rule.rule === 'type') {
      const actual = Array.isArray(val) ? 'array' : typeof val;
      if (actual !== rule.expected) why = `got ${actual}, want ${rule.expected}`;
    } else if (rule.rule === 'enum') {
      if (!rule.values.includes(val)) why = `"${val}" not in [${rule.values.join('|')}]`;
    } else if (rule.rule === 'pattern') {
      if (!rule.pattern.test(String(val))) why = `"${val}" fails format check`;
    } else if (rule.rule === 'shape') {
      why = rule.validator(val);
    }
    return { path:rule.path, rule:rule.rule, pass:!why, why };
  });

  const passed = results.filter(r=>r.pass).length;
  const typeScore = Math.round(passed / rules.length * 100);
  return { results, typeScore };
}

function renderTypeValidation(card, clean, schemaKey) {
  const tv = validateTypes(clean, schemaKey);
  if (!tv.results.length) return;
  const body = card.querySelector('.cbody');
  if (!body) return;
  let html = `<div class="tv-wrap">`;
  html += tv.results.map(r => `
    <div class="tv-row">
      <span class="tv-field ${r.pass?'ok':''}">${r.path}</span>
      <span class="tv-rule">${r.rule}</span>
      <span class="tv-st ${r.pass?'p':'f'}">${r.pass?'✓':'✗'}</span>
      ${r.why ? `<span class="tv-why" title="${esc(r.why)}">${esc(r.why)}</span>` : ''}
    </div>`).join('');
  html += `</div>`;
  body.insertAdjacentHTML('beforeend', html);
  // Blend type score into convergence bar
  if (tv.typeScore !== undefined) {
    const el = document.getElementById('cscore');
    if (el && el.dataset.prescore) {
      const blended = Math.round((parseInt(el.dataset.prescore) + tv.typeScore) / 2);
      el.dataset.typescore = tv.typeScore;
    }
  }
}


// ── REPLAY ENGINE ─────────────────────────────────────────────────────────────
let RPL = { steps:[], cur:0, timer:null, sid:null };

function openReplay(sid) {
  closeHistory();
  const records = hlLoad();
  const r = records.find(x => x.session_id === sid);
  if (!r) return;

  // Build steps array from stored record
  const steps = [];

  // L1 Gate open
  steps.push({
    type:'gate', label:'L1', sublabel:'GATE',
    model:'L1 KERNEL', role:'GATE CHECK', status:'gate',
    score:null,
    content:`Command received.\nSchema: ${r.schema_name}\nMax bounces: ${r.max_bounces}\nThreshold: ${r.threshold}%\nCommand: ${(r.command||'').slice(0,120)}\n\n→ ROUTING TO L2 EXECUTOR`
  });

  // Bounce steps
  for (const b of (r.bounces||[])) {
    const passed = b.score >= r.threshold;
    steps.push({
      type: passed ? 'pass' : 'fail',
      label: `B${b.bn}`,
      sublabel: b.model ? b.model.split('/')[0].trim() : '',
      model: b.model || '—',
      role: b.role || '—',
      status: passed ? 'pass' : 'fail',
      score: b.score,
      content: b.output_preview || '(no preview stored)',
      failed: b.failed || [],
      passed_fields: b.passed || []
    });

    // L1 gate after each bounce
    steps.push({
      type:'gate', label:'L1', sublabel:passed?'PASS':'FAIL',
      model:'L1 KERNEL', role:'GATE CHECK', status:'gate',
      score:b.score,
      content:`${passed?'✓':'✗'} Bounce ${b.bn} — ${b.score}%\n${b.failed?.length?'Missing: '+b.failed.join(', '):'All required fields present'}`
    });
  }

  // GPT fact-check (if we have the data)
  if (r.gpt_result) {
    const gptPass = r.gpt_result.includes('VERDICT: PASS');
    steps.push({
      type: gptPass ? 'pass' : 'fail',
      label:'GPT', sublabel:'CHECK',
      model:'GPT / gpt-4o-mini', role:'FACT-CHECKER',
      status: gptPass ? 'pass' : 'fail',
      score:null,
      content: r.gpt_result
    });
  }

  // L0 decision
  const decStatus = r.decision==='APPROVE'?'pass':r.decision==='DENY'?'fail':'gate';
  steps.push({
    type: decStatus,
    label:'L0', sublabel:r.decision||'—',
    model:'L0 / ARMAND LEFEBVRE', role:'DECISION',
    status: decStatus,
    score:null,
    content:`DECISION: ${r.decision||'—'}\nSession: ${r.session_id}\nFinal score: ${r.final_score}%\n${r.decision==='APPROVE'?'✓ Approved. Entity file downloaded.':r.decision==='DENY'?'✗ Denied.':'⟳ Redirected for revision.'}`
  });

  RPL.steps = steps;
  RPL.cur = 0;
  RPL.sid = sid;

  // Build timeline
  const tl = document.getElementById('rplTimeline');
  tl.innerHTML = steps.map((s, i) => `
    ${i>0?'<div class="rpl-connector"></div>':''}
    <div class="rpl-node ${s.type}" id="rplNode${i}" onclick="rplGoTo(${i})">
      <div class="rpl-dot"></div>
      <div class="rpl-nlabel">${s.label}</div>
      ${s.score!==null?`<div class="rpl-nscore">${s.score}%</div>`:''}
    </div>`).join('');

  document.getElementById('rplSub').textContent =
    `${r.session_id} · ${r.schema_name} · ${(r.bounces||[]).length} bounces · ${r.final_score}% · ${r.decision||'—'}`;

  document.getElementById('rplOverlay').classList.add('open');
  rplGoTo(0);
}

function closeReplay() {
  document.getElementById('rplOverlay').classList.remove('open');
  rplStopAuto();
}

function rplGoTo(i) {
  if (i < 0 || i >= RPL.steps.length) return;
  RPL.cur = i;
  const s = RPL.steps[i];

  // Highlight active node
  document.querySelectorAll('.rpl-node').forEach((n,j)=>{
    n.classList.toggle('active', j===i);
  });

  // Render step card
  const body = document.getElementById('rplBody');
  const failBadges = (s.failed||[]).map(f=>`<span class="rpl-badge fail">✗ ${f}</span>`).join('');
  const passBadges = (s.passed_fields||[]).map(f=>`<span class="rpl-badge pass">✓ ${f}</span>`).join('');

  body.innerHTML = `
    <div class="rpl-step-card ${s.status}">
      <div class="rpl-step-head">
        <div>
          <div class="rpl-step-model">${s.model}</div>
          <div class="rpl-step-role">${s.role}</div>
        </div>
        ${s.score!==null?`<div class="rpl-step-score">${s.score}%</div>`:'<span class="rpl-badge ${s.status}">${s.status.toUpperCase()}</span>'}
      </div>
      ${(failBadges||passBadges)?`<div class="rpl-meta-row">${failBadges}${passBadges}</div>`:''}
      <div class="rpl-step-output">${esc(s.content)}</div>
    </div>`;

  // Nav state
  document.getElementById('rplPrev').disabled = i===0;
  document.getElementById('rplNext').disabled = i===RPL.steps.length-1;
  document.getElementById('rplProg').textContent = `STEP ${i+1} / ${RPL.steps.length}`;
}

function rplStep(dir) { rplGoTo(RPL.cur + dir); }

function rplToggleAuto() {
  const btn = document.getElementById('rplAuto');
  if (RPL.timer) {
    rplStopAuto();
  } else {
    btn.textContent = '■ STOP';
    btn.classList.add('playing');
    RPL.timer = setInterval(() => {
      if (RPL.cur >= RPL.steps.length-1) { rplStopAuto(); return; }
      rplStep(1);
    }, 1800);
  }
}

function rplStopAuto() {
  clearInterval(RPL.timer);
  RPL.timer = null;
  const btn = document.getElementById('rplAuto');
  if(btn){btn.textContent='▶ AUTO';btn.classList.remove('playing');}
}

// Hook into history detail — add Replay button
const _origShowHistoryDetail = showHistoryDetail;
function showHistoryDetail(sid) {
  _origShowHistoryDetail(sid);
  // Append replay button after render
  setTimeout(() => {
    const detail = document.getElementById('hdrw-detail');
    if (!detail) return;
    // Avoid duplicates
    if (detail.querySelector('.rpl-launch-btn')) return;
    const btn = document.createElement('div');
    btn.style.cssText = 'padding:0 16px 12px';
    btn.innerHTML = `<button class="rpl-launch-btn" onclick="openReplay('${sid}')" style="width:100%;padding:10px;background:none;border:1px solid var(--green);color:var(--green);font-family:'Bebas Neue',sans-serif;font-size:16px;letter-spacing:3px;cursor:pointer">▶ REPLAY SESSION</button>`;
    const body = detail.querySelector('.hdet-body');
    if(body) body.prepend(btn.firstElementChild);
  }, 50);
}

// ── GITHUB PUSH ───────────────────────────────────────────────────────────────
function toggleGHPanel() {
  const p = document.getElementById('ghpanel');
  p.classList.toggle('open');
  if (p.classList.contains('open') && S.sid) {
    // Auto-fill path with session ID
    const pathEl = document.getElementById('gh-path');
    if (!pathEl.value) pathEl.value = `entities/${S.sid}.lds.json`;
    const msgEl = document.getElementById('gh-msg');
    if (!msgEl.value) msgEl.value = `ADD: LDS entity ${S.sid} via BOUNCE`;
  }
}

async function ghPush() {
  const owner = document.getElementById('gh-owner').value.trim();
  const repo  = document.getElementById('gh-repo').value.trim();
  const branch = document.getElementById('gh-branch').value.trim() || 'main';
  const path  = document.getElementById('gh-path').value.trim();
  const msg   = document.getElementById('gh-msg').value.trim();
  const pat   = document.getElementById('gh-pat').value.trim();
  const status = document.getElementById('gh-status');

  if (!owner||!repo||!path||!msg||!pat) {
    status.textContent='⚠ Fill in all fields.';status.className='gh-status err';return;
  }
  if (!S.final) {
    status.textContent='⚠ No approved entity to push.';status.className='gh-status err';return;
  }

  const btn = document.getElementById('gh-push-btn');
  btn.disabled = true;
  status.textContent='Pushing…';status.className='gh-status running';

  try {
    // Check if file exists to get SHA (required for update)
    let sha = null;
    const checkUrl = `https://api.github.com/repos/${owner}/${repo}/contents/${path}?ref=${branch}`;
    const checkRes = await fetch(checkUrl, {
      headers:{ 'Authorization':'Bearer '+pat, 'Accept':'application/vnd.github+json' }
    });
    if (checkRes.ok) {
      const existing = await checkRes.json();
      sha = existing.sha;
    }

    const content = btoa(unescape(encodeURIComponent(S.final)));
    const body = { message:msg, content, branch };
    if (sha) body.sha = sha;

    const pushUrl = `https://api.github.com/repos/${owner}/${repo}/contents/${path}`;
    const res = await fetch(pushUrl, {
      method:'PUT',
      headers:{
        'Authorization':'Bearer '+pat,
        'Accept':'application/vnd.github+json',
        'Content-Type':'application/json'
      },
      body:JSON.stringify(body)
    });

    if (!res.ok) {
      const err = await res.json();
      throw new Error(err.message || res.status);
    }
    const data = await res.json();
    status.textContent=`✓ Pushed: ${data.content?.html_url ? data.content.name : path}`;
    status.className='gh-status ok';
    // Log to session card
    addCard(0,'GITHUB','PUSH','GATE',`✓ Entity pushed to ${owner}/${repo}/${path}\nBranch: ${branch}\nCommit: ${msg}`,null);
  } catch(err) {
    status.textContent='✗ '+err.message;
    status.className='gh-status err';
  } finally {
    btn.disabled = false;
  }
}

// ── CUSTOM SCHEMA SYNC ────────────────────────────────────────────────────────
// Load user-defined schemas from localStorage and inject into SCHEMAS + dropdown
const CUSTOM_SCHEMA_KEY = 'vk-custom-schemas-v1';

function loadCustomSchemas() {
  try { return JSON.parse(localStorage.getItem(CUSTOM_SCHEMA_KEY) || '[]'); }
  catch(e) { return []; }
}

function injectCustomSchemas() {
  const customs = loadCustomSchemas();
  const sel = document.getElementById('schema');
  // Remove previously injected custom options
  Array.from(sel.options).forEach(opt => {
    if (opt.dataset.custom) sel.removeChild(opt);
  });
  for (const cs of customs) {
    // Register into SCHEMAS runtime object
    SCHEMAS['custom_'+cs.id] = {
      name: cs.name + ' (custom)',
      req: cs.fields.filter(f=>f.required).map(f=>f.path),
      sys: `You are a precise JSON entity generator. Follow the schema exactly.\nRequired fields: ${cs.fields.filter(f=>f.required).map(f=>f.path+' ('+f.type+')').join(', ')}.\nOutput ONLY raw JSON. Start with {. End with }. No markdown.`
    };
    const opt = document.createElement('option');
    opt.value = 'custom_'+cs.id;
    opt.textContent = cs.name + ' (v'+cs.version+')';
    opt.dataset.custom = '1';
    sel.appendChild(opt);
  }
}

// Call on load + listen for storage changes from schema.html
window.addEventListener('load', () => { injectCustomSchemas(); });
window.addEventListener('storage', e => {
  if (e.key === CUSTOM_SCHEMA_KEY) injectCustomSchemas();
});

function toggleMode(){
  document.body.classList.toggle('light');
  const tog=document.getElementById('modetog');
  tog.textContent=document.body.classList.contains('light')?'●':'◑';
  localStorage.setItem('vk-theme',document.body.classList.contains('light')?'light':'dark');
}
// Restore preference
if(localStorage.getItem('vk-theme')==='light'){document.body.classList.add('light');document.getElementById('modetog').textContent='●'}
</script>

<!-- History overlay -->
<div class="hoverlay" id="hoverlay" onclick="closeHistory()"></div>

<!-- History drawer -->
<div class="hdrw" id="hdrw">
  <div class="hdrw-head">
    <div class="hdrw-title">AUDIT LOG</div>
    <button class="hdrw-close" onclick="closeHistory()">✕ CLOSE</button>
  </div>
  <div class="hdrw-search">
    <input type="text" id="hsearch" placeholder="Search sessions..." oninput="renderHistoryList()">
  </div>
  <div class="hdrw-list" id="hdrw-list"></div>
  <div class="hdrw-detail" id="hdrw-detail"></div>
  <div class="hdrw-foot">
    <button class="hdrw-btn" onclick="exportHistory()">EXPORT JSON</button>
    <button class="hdrw-btn" onclick="importHistoryPrompt()">IMPORT</button>
    <button class="hdrw-btn danger" onclick="clearHistory()">CLEAR ALL</button>
  </div>
</div>
<input type="file" id="himport" accept=".json" style="display:none" onchange="importHistory(event)">


<!-- Replay Modal -->
<div class="rpl-overlay" id="rplOverlay" onclick="if(event.target===this)closeReplay()">
  <div class="rpl-modal">
    <div class="rpl-head">
      <div>
        <div class="rpl-title">SESSION REPLAY</div>
        <div class="rpl-sub" id="rplSub">—</div>
      </div>
      <button class="rpl-close" onclick="closeReplay()">✕ CLOSE</button>
    </div>
    <div class="rpl-timeline" id="rplTimeline"></div>
    <div class="rpl-body" id="rplBody"></div>
    <div class="rpl-nav">
      <button class="rpl-navbtn" id="rplPrev" onclick="rplStep(-1)">← PREV</button>
      <div style="display:flex;gap:8px;align-items:center">
        <button class="rpl-autoplay" id="rplAuto" onclick="rplToggleAuto()">▶ AUTO</button>
        <span class="rpl-progress" id="rplProg">—</span>
      </div>
      <button class="rpl-navbtn" id="rplNext" onclick="rplStep(1)">NEXT →</button>
    </div>
  </div>
</div>
</body>
</html>
